---
title: "SNAP2_IV_Sensitivity_Analyses_Github"
author: "Ruaraidh Campbell"
date: '2024-03-03'
output: html_document
---

This R Markdown script should be run only after the Main_Analyses script. This is because it uses datasets & the MOR (Median Odds Ratio) function generated in the course of the the Main_Analyses script. 

This script was run using R Version 4.0.3 in RStudio Version 1.2.5033. It utilises results generated from Stata scripts run using Stata Release 17. Which Stata scripts should be run at which time are indicated during the course of the script. As a result, although this is a R markdown file, Knitting the file generate errors. It should therefore be run code-chunk by code-chunk. 

NB - Please note that ICU (Intensive Care Unit) & CCU (Critical Care Unit) are used interchangeably throughout this script. As per the Methods section of the manuscript, they both refer to any of an Intensive Care Unit, High Dependency Unit, Post-Anaesthetic Recovery Unit or an Overnight Intensive Recovery Unit. 


# Load libraries needed
```{r}
library(tidyverse)
library(readxl)
library(finalfit)
library(Hmisc)
library(naniar)
library(sjPlot)
library(broom)
library(arm)
library(readr)
library(margins)
library(parameters)
library(sandwich)
library(lmtest)
library(estimatr)
library(miceadds)
library(DescTools)
```

# Sensitivity Analysis 1: Patients excluded from sites missing occupancy data

## Compare patients excluded because sites had >20% missing data to those included
Create dataset which specifies if patients were from sites with missing data > 20 or not
```{r}
missing20_site_dataset_clean <- left_join(patients_labelled5, site_drop, by="SiteCode") #join with main dataset. 
missing20_site_dataset_clean <- missing20_site_dataset_clean %>%
  mutate(missing20 = ifelse(ratio_bed < 0.2 | is.na(ratio_bed), "N", "Y")) %>% 
   mutate(missing20 = factor(missing20))


save(missing20_site_dataset_clean, file='missing20_site_dataset_clean.rda')
```

Impute missing data in blood tests as "normal"
```{r}
# create variable that indicates if a blood test value was imputed
missing20_site_dataset_clean_imputed <- missing20_site_dataset_clean %>% 
  mutate(imputed_creatinine = ifelse(is.na(creatinine_category.factor), 1, 0)) %>% 
  mutate(imputed_urea = ifelse(is.na(urea_category.factor), 1, 0)) %>% 
  mutate(imputed_hb = ifelse(is.na(hb_category.factor), 1, 0)) %>% 
  mutate(imputed_sodium = ifelse(is.na(sodium_category.factor), 1, 0)) %>% 
  mutate(imputed_potassium = ifelse(is.na(potassium_category.factor), 1, 0)) %>% 
  mutate(imputed_wcc = ifelse(is.na(wcc_category.factor), 1, 0)) %>% 
  mutate(imputed_hba1c = ifelse(is.na(hba1c_category.factor), 1, 0))

# create variables where missing blood test values are imputed as "normal"
missing20_site_dataset_clean_imputed <- missing20_site_dataset_clean_imputed %>% 
  mutate(impute_normal_creatinine_category = case_when(is.na(creatinine_category.factor) ~ "Normal",
                                                              TRUE ~ as.character(creatinine_category.factor))) %>% 
  mutate(impute_normal_creatinine_category.factor = factor(impute_normal_creatinine_category) %>% 
           fct_relevel("Low", "Normal", "High")) %>%  
  mutate(impute_normal_urea_category = case_when(is.na(urea_category.factor) ~ "Normal",
                                                              TRUE ~ as.character(urea_category.factor))) %>% 
  mutate(impute_normal_urea_category.factor = factor(impute_normal_urea_category) %>% 
           fct_relevel("Low", "Normal", "High")) %>% 
  mutate(impute_normal_hb_category = case_when(is.na(hb_category.factor) ~ "Normal",
                                                              TRUE ~ as.character(hb_category.factor))) %>% 
  mutate(impute_normal_hb_category.factor = factor(impute_normal_hb_category) %>% 
           fct_relevel("Low", "Normal", "High")) %>% 
  mutate(impute_normal_sodium_category = case_when(is.na(sodium_category.factor) ~ "Normal",
                                                              TRUE ~ as.character(sodium_category.factor))) %>% 
  mutate(impute_normal_sodium_category.factor = factor(impute_normal_sodium_category) %>% 
           fct_relevel("Low", "Normal", "High")) %>% 
  mutate(impute_normal_potassium_category = case_when(is.na(potassium_category.factor) ~ "Normal",
                                                              TRUE ~ as.character(potassium_category.factor))) %>% 
  mutate(impute_normal_potassium_category.factor = factor(impute_normal_potassium_category) %>% 
           fct_relevel("Low", "Normal", "High")) %>% 
  mutate(impute_normal_wcc_category = case_when(is.na(wcc_category.factor) ~ "Normal",
                                                              TRUE ~ as.character(wcc_category.factor))) %>% 
  mutate(impute_normal_wcc_category.factor = factor(impute_normal_wcc_category) %>% 
           fct_relevel("Low", "Normal", "High")) %>% 
  mutate(impute_normal_hba1c_category = case_when(is.na(hba1c_category.factor) ~ "Normal",
                                                              TRUE ~ as.character(hba1c_category.factor))) %>% 
  mutate(impute_normal_hba1c_category.factor = factor(impute_normal_hba1c_category) %>% 
           fct_relevel("Normal", "High"))

# create abnormal blood test variables which accounts for imputed blood tests  
missing20_site_dataset_clean_imputed <- missing20_site_dataset_clean_imputed %>%
  mutate(abnormal_bloodtest_impute_normal = ifelse(impute_normal_creatinine_category.factor == "Low" |
                                                     impute_normal_creatinine_category.factor == "High" |
                                                     impute_normal_urea_category.factor == "Low" |
                                                     impute_normal_urea_category.factor == "High" |
                                                     impute_normal_hb_category.factor == "Low" |
                                                     impute_normal_hb_category.factor == "High" |
                                                     impute_normal_sodium_category.factor == "Low" |
                                                     impute_normal_sodium_category.factor == "High" |
                                                     impute_normal_potassium_category.factor == "Low" |
                                                     impute_normal_potassium_category.factor == "High" |
                                                     impute_normal_wcc_category.factor == "Low" |
                                                     impute_normal_wcc_category.factor == "High", 1, 0)) %>% 
  mutate(abnormal_bloodtest_impute_normal.factor = factor(abnormal_bloodtest_impute_normal))


save(missing20_site_dataset_clean_imputed, file = 'missing20_site_dataset_clean_imputed.rda')
load(file = 'missing20_site_dataset_clean_imputed.rda')
```

Investigate if there are significant differences in outcomes or characteristics between patients at the excluded vs included sites?
```{r}
explanatory_missing_site = c("S01Gender" ,
          "S01Age" , 
          "asa"  ,
          "SORT_mort_perc_cat" ,
          "combined_DHx"  ,
         "combined_PMHx" ,
         "diabetes.factor" ,
         "dyspnoea.factor"  ,
         "combined_radiology_findings"  ,
         "creatinine_category.factor" ,
          "urea_category.factor",
          "hb_category.factor" ,
          "sodium_category.factor" ,
          "potassium_category.factor"  ,
          "wcc_category.factor" ,
         "procedure_count.factor",
         "S02PatientOrigin" ,
         "S02LevelOfSupport",
         "PreopLOS.factor",
         "GCS_category.factor" ,
         "S03SystolicBloodPressureBpAtPreAssessment" ,
          "S03PulseRateAtPreoperativeAssessment" ,
         "pre_assessment_include_na"  ,
          "S02OperativeUrgency" ,
         "S02PlannedProcSeverity" ,
         "S04AnaestheticTechniqueGeneral",
         "weekend.factor" ,
         "night_surgery.factor"  ,
          "Anaesthetist_grade_combined.factor"  ,
          "Surgeon_grade_combined.factor"  ,
          "S04CriticalUnexpectedEventsPerioperatively"  ,
          "S04BloodLoss" ,
         "POMS.factor"  ,
         "S07PostopLOS"  ,
          "mortality30.factor"  ,
          "mortality60.factor" ,
         "CCUCapacityTimeofSurgCat" )
dependent_missing_site = "missing20"


Missing20_characteristics_table <- missing20_site_dataset_clean %>% 
  summary_factorlist(dependent_missing_site,
                     explanatory_missing_site, 
                     na_include=TRUE, na_include_dependent = TRUE, 
                    total_col = TRUE, add_col_totals = TRUE,  p=TRUE) %>% view()


# examine pattern of missingness in variables of interest in excluded patients compared to included
missing20_site_dataset_narrowed <- missing20_site_dataset_clean_imputed %>% 
  dplyr::select(POMS.factor, postmort30, mortality30.factor, postmort60, mortality60.factor, icu_adm.factor, CaseId, SiteCode, S01Gender, S01Age, S02PatientOrigin, weekend.factor, country, procedure_count.factor, S02OperativeUrgency, S02PlannedProcSeverity, S03AsaPsClass, asa, S04AnaestheticTechniqueGeneral, combined_anaesthetic_type, S02LevelOfSupport, S02PreopLOS, malignancy.factor, combined_radiology_findings, combined_PMHx, combined_DHx, S03PastMedicalHistoryCoronaryArteryDisease, S03PastMedicalHistoryCongestiveCardiacFailure, S03PastMedicalHistoryStrokeTIA, S03PastMedicalHistoryDementia, S03PastMedicalHistoryCOPD, S03PastMedicalHistoryPulmonaryFibrosis, S03PastMedicalHistoryLiverCirrhosis, S03PastMedicalHistoryRenalDisease, S03PastMedicalHistoryComplexPolytrauma, S03PastMedicalHistoryCancerLast5Yrs, S03PastMedicalHistoryMetastaticCancerCurrent, S03Diabetes, diabetes.factor, S03GlasgowComaScaleGcsPreInductionOfAnaesthesia, GCS_category.factor, S03SystolicBloodPressureBpAtPreAssessment, S03PulseRateAtPreoperativeAssessment, dyspnoea.factor, night_surgery.factor, surgery_start_time.factor, surgery_end_time.factor, S03GradeOfMostSeniorAnaesthetistPresent, S03GradeOfMostSeniorSurgeonPresent , S02PreoperativeAssessmentBeforeHospitalAdmission,  BMI.factor, S03ElevatedJugularVenousPressureJvp, S03PeripheralOedema, creatinine_category.factor, urea_category.factor, hb_category.factor, sodium_category.factor, potassium_category.factor, wcc_category.factor, hba1c_category.factor, ecg,  periop_team_mort_estimate.factor, S03PatientRequiresCriticalCareAfterTheirOperation, S03ReasonReferredForPostoperativeCriticalCare,  S04CriticalUnexpectedEventsPerioperatively, S04BloodLoss, S04ImmediatePostoperativeDestination,S07PlannedDayOfSurgeryIcuHduPacuAdmission, S07UnplannedDayOfSurgeryIcuHduPacuAdmission, S07UnplannedPostoperativeIcuHduAdmissionAfterDayOfSurgery, S07PostopLOS, S07NumberOfDaysSpentInCriticalCareAfterSurgery, missing20)

missing20_site_dataset_narrowed %>% filter(missing20 == "Y") %>% ff_glimpse()
missing20_site_dataset_narrowed %>% filter(missing20 == "N") %>% ff_glimpse()

# Pattern of missing data is similar between the excluded and included patients, other than pre-op assessment prior to hospital admission and BMI

# Save objects for exporting
save(Missing20_characteristics_table, file = "missing20_baseline_table.rda")
```

## Run Analyses to evaluate the effect of postoperative Critical Care admission on Outcomes with patients from sites with >20% missing data to compare to main analyses

## Unadjusted analyses

### Primary outcome: POMS
```{r, results=TRUE}
missing20_log_poms_unadj <- glm(POMS.factor ~ icu_adm.factor,
                data = missing20_site_dataset_clean_imputed,
                family = "binomial")

log_odds_table_missing20_log_poms_unadj <- missing20_log_poms_unadj %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_poms_unadj, file='log_odds_table_missing20_log_poms_unadj.rda')
odds_ratio_table_missing20_log_poms_unadj <- missing20_log_poms_unadj %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_poms_unadj, file='odds_ratio_table_missing20_log_poms_unadj.rda')
av_marg_eff_missing20_log_poms_unadj <- margins(missing20_log_poms_unadj, variables = c("icu_adm.factor")) %>% summary()

```

### Secondary outcomes: Mortality

```{r}
# 30 day
missing20_log_mort30_unadj <- glm(mortality30.factor ~ icu_adm.factor,
                data = missing20_site_dataset_clean_imputed,
                family = "binomial")

log_odds_table_missing20_log_mort30_unadj <- missing20_log_mort30_unadj %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort30_unadj, file='log_odds_table_missing20_log_mort30_unadj.rda')
odds_ratio_table_missing20_log_mort30_unadj <- missing20_log_mort30_unadj %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_mort30_unadj, file='odds_ratio_table_missing20_log_mort30_unadj.rda')
av_marg_eff_missing20_log_mort30_unadj <- margins(missing20_log_mort30_unadj, variables = c("icu_adm.factor")) %>% summary()

# 60 day
missing20_log_mort60_unadj <- glm(mortality60.factor ~ icu_adm.factor,
                data = missing20_site_dataset_clean_imputed,
                family = "binomial")

log_odds_table_missing20_log_mort60_unadj <- missing20_log_mort60_unadj %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort60_unadj, file='log_odds_table_missing20_log_mort60_unadj.rda')
odds_ratio_table_missing20_log_mort60_unadj <- missing20_log_mort60_unadj %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_mort60_unadj, file='odds_ratio_table_missing20_log_mort60_unadj.rda')
av_marg_eff_missing20_log_mort60_unadj <- margins(missing20_log_mort60_unadj, variables = c("icu_adm.factor")) %>% summary()
```

### Secondary outcome: LOS
```{r}
library(MASS)
library(magrittr)
# Negative binomial regression used for count data
missing20_log_los_unadj <- glm.nb(S07PostopLOS ~ icu_adm.factor, data = missing20_site_dataset_clean_imputed)
missing20_log_los_unadj %>% tidy(conf.int = TRUE, exp = TRUE)

```

## Adjusted analyses

### Primary outcome: POMS
```{r}
## Single-level logistic regression (without cluster SEs)
missing20_log_poms <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = missing20_site_dataset_clean_imputed,
                family = "binomial")

summary(missing20_log_poms)
log_odds_table_missing20_log_poms <- missing20_log_poms %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_poms, file='log_odds_table_missing20_log_poms.rda')
odds_ratio_table_missing20_log_poms <- missing20_log_poms %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_poms, file='odds_ratio_table_missing20_log_poms.rda')
av_marg_eff_missing20_log_poms <- margins(missing20_log_poms, variables = c("icu_adm.factor")) %>% summary()


## Single-level logistic regression with cluster robust SEs
missing20_log_poms_cluster <- coeftest(missing20_log_poms, vcov = vcovCL, cluster = ~ SiteCode)
missing20_log_poms_cluster 
log_odds_table_missing20_log_poms_cluster <- missing20_log_poms_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_poms_cluster, file='log_odds_table_missing20_log_poms_cluster.rda')
odds_ratio_table_missing20_log_poms_cluster <- log_odds_table_missing20_log_poms_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_missing20_log_poms_cluster, file='odds_ratio_table_missing20_log_poms_cluster.rda')

## Random intercept model
missing20_log_poms_random_effect <- missing20_site_dataset_clean_imputed %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( missing20_log_poms_random_effect)
log_odds_table_missing20_log_poms_random_effect <- missing20_log_poms_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_poms_random_effect, file='log_odds_table_missing20_log_poms_random_effect.rda')
odds_ratio_table_missing20_log_poms_random_effect <- missing20_log_poms_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_poms_random_effect, file='odds_ratio_table_missing20_log_poms_random_effect.rda')
```


## Secondary outcomes: 

### 30 day Mortality
```{r}
## Single-level logistic regression (without cluster SEs)
missing20_log_mort30 <- glm(mortality30.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = missing20_site_dataset_clean_imputed,
                family = "binomial")

summary(missing20_log_mort30)
log_odds_table_missing20_log_mort30 <- missing20_log_mort30 %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort30, file='log_odds_table_missing20_log_mort30.rda')
odds_ratio_table_missing20_log_mort30 <- missing20_log_mort30 %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_mort30, file='odds_ratio_table_missing20_log_mort30.rda')
av_marg_eff_missing20_log_mort30 <- margins(missing20_log_mort30, variables = c("icu_adm.factor")) %>% summary()


## Single-level logistic regression with cluster robust SEs
missing20_log_mort30_cluster <- coeftest(missing20_log_mort30, vcov = vcovCL, cluster = ~ SiteCode)
missing20_log_mort30_cluster
log_odds_table_missing20_log_mort30_cluster <- missing20_log_mort30_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort30_cluster, file='log_odds_table_missing20_log_mort30_cluster.rda')
odds_ratio_table_missing20_log_mort30_cluster <- log_odds_table_missing20_log_mort30_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_missing20_log_mort30_cluster, file='odds_ratio_table_missing20_log_mort30_cluster.rda')

## Random intercept model
missing20_log_mort30_random_effect <-  missing20_site_dataset_clean_imputed %>% 
  glmer(mortality30.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( missing20_log_mort30_random_effect)
log_odds_table_missing20_log_mort30_random_effect <- missing20_log_mort30_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort30_random_effect, file='log_odds_table_missing20_log_mort30_random_effect.rda')
odds_ratio_table_missing20_log_mort30_random_effect <- missing20_log_mort30_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_mort30_random_effect, file='odds_ratio_table_missing20_log_mort30_random_effect.rda')
```


### 60 day Mortality
```{r}
## Single-level logistic regression (without cluster SEs)
missing20_log_mort60 <- glm(mortality60.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = missing20_site_dataset_clean_imputed,
                family = "binomial")

summary(missing20_log_mort60)
log_odds_table_missing20_log_mort60 <- missing20_log_mort60 %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort60, file='log_odds_table_missing20_log_mort60.rda')
odds_ratio_table_missing20_log_mort60 <- missing20_log_mort60 %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_mort60, file='odds_ratio_table_missing20_log_mort60.rda')
av_marg_eff_missing20_log_mort60 <- margins(missing20_log_mort60, variables = c("icu_adm.factor")) %>% summary()


## Single-level logistic regression with cluster robust SEs
missing20_log_mort60_cluster <- coeftest(missing20_log_mort60, vcov = vcovCL, cluster = ~ SiteCode)
missing20_log_mort60_cluster
log_odds_table_missing20_log_mort60_cluster <- missing20_log_mort60_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort60_cluster, file='log_odds_table_missing20_log_mort60_cluster.rda')
odds_ratio_table_missing20_log_mort60_cluster <- log_odds_table_missing20_log_mort60_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_missing20_log_mort60_cluster, file='odds_ratio_table_missing20_log_mort60_cluster.rda')

## Random intercept model
missing20_log_mort60_random_effect <-  missing20_site_dataset_clean_imputed %>% 
  glmer(mortality60.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( missing20_log_mort60_random_effect)
log_odds_table_missing20_log_mort60_random_effect <- missing20_log_mort60_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_missing20_log_mort60_random_effect, file='log_odds_table_missing20_log_mort60_random_effect.rda')
odds_ratio_table_missing20_log_mort60_random_effect <- missing20_log_mort60_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_mort60_random_effect, file='odds_ratio_table_missing20_log_mort60_random_effect.rda')
```

### Consolidate results into a table
```{r}
## POMS
a <- log_odds_table_missing20_log_poms[2,]
b <- log_odds_table_missing20_log_poms_cluster[2,]
c <- log_odds_table_missing20_log_poms_random_effect[2, c(3,4,5,6,7,8,9)]


missing20_poms_log_odds_est <- rbind(a,b,c) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs",  "Random intercept model")) %>% 
  dplyr::select("model", everything())

save(missing20_poms_log_odds_est, file='missing20_poms_log_odds_est.rda')

## 30 day mortality
a <- log_odds_table_missing20_log_mort30[2,]
b <- log_odds_table_missing20_log_mort30_cluster[2,]
c <- log_odds_table_missing20_log_mort30_random_effect[2, c(3,4,5,6,7,8,9)]


missing20_mort30_log_odds_est <- rbind(a,b,c) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs",  "Random intercept model")) %>% 
  dplyr::select("model", everything())

save(missing20_mort30_log_odds_est, file='missing20_mort30_log_odds_est.rda')

## 60 day mortality
a <- log_odds_table_missing20_log_mort60[2,]
b <- log_odds_table_missing20_log_mort60_cluster[2,]
c <- log_odds_table_missing20_log_mort60_random_effect[2, c(3,4,5,6,7,8,9)]


missing20_mort60_log_odds_est <- rbind(a,b,c) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs",  "Random intercept model")) %>% 
  dplyr::select("model", everything())

save(missing20_mort60_log_odds_est, file='missing20_mort60_log_odds_est.rda')
```


### Post-op LOS
```{r}
missing20_log_los_multivariable <- glm.nb(S07PostopLOS ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,  
                  data = missing20_site_dataset_clean_imputed)

log_odds_table_missing20_log_los_multivariable <- missing20_log_los_multivariable %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_missing20_log_los_multivariable, file='log_odds_table_missing20_log_los_multivariable.rda')
odds_ratio_table_missing20_log_los_multivariable <- missing20_log_los_multivariable %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_missing20_log_los_multivariable, file='odds_ratio_table_missing20_log_los_multivariable.rda')
```

IN SUMMARY: repeating the analysis including the excluded patients does not significantly alter the results of the Univariable or Multivariable regression. Unable to do the IV analysis as this intrinsically requires the missing occupancy data. 


# Sensitivity Analysis 2: Complete Case Analysis
Create dataset of complete case patients
```{r}
# Complete case datset for POMS
complete_case_data_poms <- patients_labelled6 %>% 
  dplyr::select(POMS.factor, icu_adm.factor,  S01Gender  , age_p10  , weekend.factor  ,  S02OperativeUrgency  , S02PlannedProcSeverity  , asa  ,  PreopLOS.factor  ,  combined_DHx  , combined_PMHx  , diabetes.factor  ,  sysBP_scaled  , HR_scaled  ,  Anaesthetist_grade_combined.factor  , Surgeon_grade_combined.factor , abnormal_bloodtest.factor , S04BloodLoss , SiteCode )

complete_case_data_poms <- complete_case_data_poms[complete.cases(complete_case_data_poms), ]

require(foreign) # write dta file for IV analyses in Stata
write.dta(complete_case_data_poms, "complete_case_data_poms.dta")

# Complete case datset for 30 day mortality
complete_case_data_mort30 <- patients_labelled6 %>% 
  dplyr::select(mortality30.factor, icu_adm.factor,  S01Gender  , age_p10  , weekend.factor  ,  S02OperativeUrgency  , S02PlannedProcSeverity  , asa  ,  PreopLOS.factor  ,  combined_DHx  , combined_PMHx  , diabetes.factor  ,  sysBP_scaled  , HR_scaled  ,  Anaesthetist_grade_combined.factor  , Surgeon_grade_combined.factor , abnormal_bloodtest.factor , S04BloodLoss , SiteCode )

complete_case_data_mort30 <- complete_case_data_mort30[complete.cases(complete_case_data_mort30), ]

# Complete case datset for 60 day mortality
complete_case_data_mort60 <- patients_labelled6 %>% 
  dplyr::select(mortality60.factor, icu_adm.factor,  S01Gender  , age_p10  , weekend.factor  ,  S02OperativeUrgency  , S02PlannedProcSeverity  , asa  ,  PreopLOS.factor  ,  combined_DHx  , combined_PMHx  , diabetes.factor  ,  sysBP_scaled  , HR_scaled  ,  Anaesthetist_grade_combined.factor  , Surgeon_grade_combined.factor , abnormal_bloodtest.factor , S04BloodLoss , SiteCode )

complete_case_data_mort60 <- complete_case_data_mort60[complete.cases(complete_case_data_mort60), ]
```

# Part 1 - Test whether the probability of admission to Critical Care is affected by bed availablity
In the first part of this analysis, we use a multivariable logistic regression analysis to investigate the above question. We construct two models: one including only patient-level variables, as well as patient-level variables and hospital-level variables. These two models then have the MOR calculated for them to investigate how the addition of these variables explains the variability between hospital sites (these MORs are compared to the random-intercept only model calculated in the previous section). 

## Run the MV regression for probability of Critical care admission depending on bed availability (including only patient-level variables, as well as patient-level variables and hospital-level variables). Also check how this affects the variability between hospital sites.
```{r}
# Run Empty "Intercept-only" model to get unadjusted MOR between hospitals
complete_case_empty_random_effects_icu_adm <- patients_labelled6 %>% 
  filter(!(is.na(abnormal_bloodtest.factor))) %>% 
  glmer(icu_adm.factor ~ (1 | SiteCode), data =., family = "binomial")

summary(complete_case_empty_random_effects_icu_adm)
odds_ratio_table_complete_case_empty_random_effects_icu_adm <- complete_case_empty_random_effects_icu_adm %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_complete_case_empty_random_effects_icu_adm, file = 'odds_ratio_table_complete_case_empty_random_effects_icu_adm.rda')
random_parameters(complete_case_empty_random_effects_icu_adm)
# variance = 0.95
my.var_complete_case_empty_icu_adm <- 0.95 
MOR_complete_case_empty_icu_adm <- my.var_complete_case_empty_icu_adm %>% MOR()


# Run mv logistic regression including patient-level effects
log_ccu_random_effect_critical_adverse_speciality_include <- patients_labelled6 %>% 
  filter(!(specialty.factor == "Other")) %>% 
  glmer(icu_adm.factor ~ CCUCapacityTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss + specialty.factor + S04CriticalUnexpectedEventsPerioperatively + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

summary(log_ccu_random_effect_critical_adverse_speciality_include) 
log_odds_table_log_ccu_random_effect_critical_adverse_speciality_include <- log_ccu_random_effect_critical_adverse_speciality_include %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_ccu_random_effect_critical_adverse_speciality_include, file='log_odds_table_log_ccu_random_effect_critical_adverse_speciality_include.rda')
odds_ratio_table_log_ccu_random_effect_critical_adverse_speciality_include <- log_ccu_random_effect_critical_adverse_speciality_include %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_ccu_random_effect_critical_adverse_speciality_include, file='odds_ratio_table_log_ccu_random_effect_critical_adverse_speciality_include.rda')

random_parameters(log_ccu_random_effect_critical_adverse_speciality_include)
my.var_random_effect_log_ccu_random_effect_critical_adverse_speciality_include <- 1.25 
MOR_random_effect_log_ccu_random_effect_critical_adverse_speciality_include <- my.var_random_effect_log_ccu_random_effect_critical_adverse_speciality_include %>% MOR() 

# run regression including patient-level effects and hospital-level variable (i.e. total icu capacity)
log_ccu_random_effect_critical_adverse_speciality_totalcap_include <- patients_labelled6 %>% 
  filter(!(specialty.factor == "Other")) %>% 
  glmer(icu_adm.factor ~ CCUCapacityTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss + specialty.factor + S04CriticalUnexpectedEventsPerioperatively + TotalCapacityTimeofSurgery + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

summary(log_ccu_random_effect_critical_adverse_speciality_totalcap_include) 
log_odds_table_log_ccu_random_effect_critical_adverse_speciality_totalcap_include <- log_ccu_random_effect_critical_adverse_speciality_totalcap_include %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_ccu_random_effect_critical_adverse_speciality_totalcap_include, file='log_odds_table_log_ccu_random_effect_critical_adverse_speciality_totalcap_include.rda')
odds_ratio_table_log_ccu_random_effect_critical_adverse_speciality_totalcap_include <- log_ccu_random_effect_critical_adverse_speciality_totalcap_include %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_ccu_random_effect_critical_adverse_speciality_totalcap_include, file='odds_ratio_table_log_ccu_random_effect_critical_adverse_speciality_totalcap_include.rda')

random_parameters(log_ccu_random_effect_critical_adverse_speciality_totalcap_include)
my.var_random_effect_log_ccu_random_effect_critical_adverse_speciality_totalcap_include <- 1.26 
MOR_random_effect_log_ccu_random_effect_critical_adverse_speciality_totalcap_include <- my.var_random_effect_log_ccu_random_effect_critical_adverse_speciality_totalcap_include %>% MOR() 

# Plot the model with patient-level effects only
log_ccu_random_effect_critical_adverse_speciality_include_plot <- plot_model(log_ccu_random_effect_critical_adverse_speciality_include, 
           rm.terms = c("age_p10.L", 
                       "age_p10.Q", 
                       "age_p10.C",
                      "age_p10^4", 
                       "age_p10^5", 
                       "age_p10^6"),
           show.p = TRUE, show.values = TRUE, value.offset = 0.4, value.size = 3, vline.color = "red", 
           title = "") +
  scale_x_discrete(labels=list(
    CCUCapacityTimeofSurgery = "Available CCU beds at time of surgery",
    S01GenderMale = "Sex : Male", 
    weekend.factorWeekend = "Weekend surgery",
    S02OperativeUrgencyExpedited = "Operative Urgency : Expedited",
    S02OperativeUrgencyUrgent = "Operative Urgency : Urgent", 
    S02OperativeUrgencyImmediate = "Operative Urgency : Immediate",
    S02PlannedProcSeverityIntermediate = "Procedure Severity : Intermediate",
    S02PlannedProcSeverityMajor = "Procedure Severity : Major", 
    S02PlannedProcSeverityXMajor = "Procedure Severity : XMajor",
    S02PlannedProcSeverityComplex = "Procedure Severity : Complex",
    asaII = "ASA II", 
    asaIII = "ASA III",
    'asaIV/V' = "ASA IV/V",
    PreopLOS.factor1 = "Preoperative Length of Stay : 1 day",
    'PreopLOS.factor2 to 6' = "Preoperative Length of Stay : 2 to 6 days", 
    'PreopLOS.factor7 to 20' = "Preoperative Length of Stay : 7 to 20 days",
    'PreopLOS.factor21 to 251' = "Preoperative Length of Stay : 21+ days",
    combined_DHxTrue = "Positive drug history for listed medications", 
    combined_PMHxTrue = "Positive past medical history of listed conditions",
    'diabetes.factorT2DM - Diet Controlled' = "Diabetes : T2DM - Diet controlled",
    'diabetes.factorT2DM - Oral medication' = "Diabetes : T2DM - Oral medication",
    'diabetes.factorT2DM - Insulin controlled' = "Diabetes : T2DM - Insulin controlled",
    'diabetes.factorT1DM' = "Diabetes : T1DM",
    sysBP_scaled = "Pre-induction systolic BP (scaled)",
    HR_scaled = "Pre-induction heart rate (scaled)",
    'Anaesthetist_grade_combined.factorNon-consultant' = "Grade of most senior Anaesthetist : Non-consultant",
    'Surgeon_grade_combined.factorNon-consultant' = "Grade of most senior Surgeon : Non-consultant",
    abnormal_bloodtest.factorTrue = "Abnormality on preoperative blood test",
    'S04BloodLoss101-500ml' = "Estimated blood loss : 101-500mls",
    'S04BloodLoss501-999ml' = "Estimated blood loss : 501-999mls",
    'S04BloodLoss>1000ml' = "Estimated blood loss : > 1000mls", 
    specialty.factorBreast = "Surgical specialty : Breast", 
    specialty.factorCardiology = "Surgical specialty : Cardiology",
    specialty.factorColorectal = "Surgical specialty : Colorectal",
    specialty.factorEndocrine = "Surgical specialty : Endocrine",
    specialty.factorEndoscopic = "Surgical specialty : Endoscopic",
    specialty.factorENT = "Surgical specialty : ENT",
    specialty.factorGynae = "Surgical specialty : Gynaecology",
    specialty.factorHPB = "Surgical specialty : HPB",
    specialty.factorIR = "Surgical specialty : Interventional Radiology",
    'specialty.factorMaxFax-Dental' = "Surgical specialty : Max-Fax/Dental",
    specialty.factorOpthalmic = "Surgical specialty : Opthalmic",
    specialty.factorOrtho = "Surgical specialty : Orthopaedics",
    specialty.factorPlastics = "Surgical specialty : Plastic Surgery",
    specialty.factorSpine = "Surgical specialty : Spine",
    specialty.factorThoracic = "Surgical specialty : Thoracic",
    specialty.factorTransplant = "Surgical specialty : Transplant",
    specialty.factorUpperGI = "Surgical specialty : Upper GI",
    specialty.factorUrology = "Surgical specialty : Urology",
    specialty.factorVascular = "Surgical specialty : Vascular",
    S04CriticalUnexpectedEventsPerioperativelyTrue = "Critical Unexpected Events Perioperatively : True"
  )) + 
  scale_y_continuous(trans='log10') +
  ylab("Odds Ratio") +
  xlab("Model feature") +
  theme_classic()

```

# Check if critical care capacity remains significant when model is restricted to the features included in the IV analysis models
This analyses uses the same model features as the models investigating the effect of critical care admission on outcomes. This is a subset of the features in the above models (specialty and critical adverse events are removed). 
- This is done as the model features need to be identical in both equations in the Instrumental variable analyses. Therefore it was necessary to check that, using these model features, there was a statistically significant effect of Critical care capacity on probability of admission - to permit it's inclusion as a valid instrument. 
- The reasons for the narrowed feature set was that, although specialty and critical adverse events were relevant for one's probability of admission, the effect was less important for outcomes - and so they added extra, unnecessary dimensionality to the model with little explanatory power. 

```{r}
## Random effects model
 log_ccu_pars_random_effect <- patients_labelled6 %>% 
  glmer(icu_adm.factor ~ CCUCapacityTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_ccu_pars_random_effect)
log_odds_table_log_ccu_pars_random_effect <- log_ccu_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_ccu_pars_random_effect, file='log_odds_table_log_ccu_pars_random_effect.rda')
odds_ratio_table_log_ccu_pars_random_effect <- log_ccu_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_ccu_pars_random_effect, file='odds_ratio_table_log_ccu_pars_random_effect.rda')
```


## Part 2 - Evaluate the effect of postoperative Critical Care admission on Outcomes
## Unadjusted analyses
### Primary outcome: POMS
```{r, results=TRUE}
POMS_unadj <- glm(POMS.factor ~ icu_adm.factor,
                data = complete_case_data_poms,
                family = "binomial")

log_odds_table_POMS_unadj <- POMS_unadj %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_POMS_unadj, file='log_odds_table_POMS_unadj.rda')
odds_ratio_table_POMS_unadj <- POMS_unadj %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_POMS_unadj, file='odds_ratio_table_POMS_unadj.rda')
av_marg_eff_POMS_unadj <- margins(POMS_unadj, variables = c("icu_adm.factor")) %>% summary()

```

### Secondary outcomes: Mortality

```{r}
# 30 day
mort30_unadj <- glm(mortality30.factor ~ icu_adm.factor,
                data = complete_case_data_mort30,
                family = "binomial")

log_odds_table_mort30_unadj <- mort30_unadj %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_mort30_unadj, file='log_odds_table_mort30_unadj.rda')
odds_ratio_table_mort30_unadj <- mort30_unadj %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_mort30_unadj, file='odds_ratio_table_mort30_unadj.rda')
av_marg_eff_mort30_unadj <- margins(mort30_unadj, variables = c("icu_adm.factor")) %>% summary()

# 60 day
mort60_unadj <- glm(mortality60.factor ~ icu_adm.factor,
                data = complete_case_data_mort60,
                family = "binomial")

log_odds_table_mort60_unadj <- mort60_unadj %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_mort60_unadj, file='log_odds_table_mort60_unadj.rda')
odds_ratio_table_mort60_unadj <- mort60_unadj %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_mort60_unadj, file='odds_ratio_table_mort60_unadj.rda')
av_marg_eff_mort60_unadj <- margins(mort60_unadj, variables = c("icu_adm.factor")) %>% summary()
```

### Secondary outcome: LOS
```{r}
library(MASS)
library(magrittr)
# Negative binomial regression used for count data
los_unadj <- glm.nb(S07PostopLOS ~ icu_adm.factor, data = patients_labelled6)
los_unadj %>% tidy(conf.int = TRUE, exp = TRUE)

```

## Adjusted analyses
For the adjusted analyses, 3 regression models were run for each outcome: A single-level logistic regression (i.e. without clustering on hospital site), A single-level logistic regression with cluster robust Std Errors (using hospital site as the cluster to adjust the Std Errors on), A multi-level (aka random effects) logistic regression with clustering by hospital site. This was done to compare the results between the different approaches. 
- For the purposes of publication, the multi-level logistic regression was chosen as the most appropriate model to report results for. 
### POMS
Single-level logistic regression (without cluster SEs)
```{r}
log_poms_pars <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss,
                data = patients_labelled6,
                family = "binomial")


summary(log_poms_pars)
log_odds_table_log_poms_pars <- log_poms_pars %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_pars, file='log_odds_table_log_poms_pars.rda')
odds_ratio_table_log_poms_pars <- log_poms_pars %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_pars, file='odds_ratio_table_log_poms_pars.rda')
av_marg_eff_log_poms_pars <- margins(log_poms_pars, variables = c("icu_adm.factor")) %>% summary()
```

 Single-level logistic regression with cluster robust SEs
```{r}
log_poms_pars_cluster <- coeftest(log_poms_pars, vcov = vcovCL, cluster = ~ SiteCode)
log_poms_pars_cluster # as expected the SEs are larger
log_odds_table_log_poms_pars_cluster <- log_poms_pars_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_pars_cluster, file='log_odds_table_log_poms_pars_cluster.rda')
odds_ratio_table_log_poms_pars_cluster <- log_odds_table_log_poms_pars_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_poms_pars_cluster, file='odds_ratio_table_log_poms_pars_cluster.rda')
```

 Random intercept model
```{r}
 log_poms_pars_random_effect <- patients_labelled6 %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_poms_pars_random_effect)
log_odds_table_log_poms_pars_random_effect <- log_poms_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_pars_random_effect, file='log_odds_table_log_poms_pars_random_effect.rda')
odds_ratio_table_log_poms_pars_random_effect <- log_poms_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_pars_random_effect, file='odds_ratio_table_log_poms_pars_random_effect.rda')
```


### 30 day mortality
Single-level logistic regression (without cluster SEs)
```{r}
log_mort30_pars <- glm(mortality30.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss,
                data = patients_labelled6,
                family = "binomial")

summary(log_mort30_pars)
log_odds_table_log_mort30_pars <- log_mort30_pars %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_mort30_pars, file='log_odds_table_log_mort30_pars.rda')
odds_ratio_table_log_mort30_pars <- log_mort30_pars %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_mort30_pars, file='odds_ratio_table_log_mort30_pars.rda')
av_marg_eff_log_mort30_pars <- margins(log_mort30_pars, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
log_mort30_pars_cluster <- coeftest(log_mort30_pars, vcov = vcovCL, cluster = ~ SiteCode)
log_mort30_pars_cluster
log_odds_table_log_mort30_pars_cluster <- log_mort30_pars_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_mort30_pars_cluster, file='log_odds_table_log_mort30_pars_cluster.rda')
odds_ratio_table_log_mort30_pars_cluster <- log_odds_table_log_mort30_pars_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_mort30_pars_cluster, file='odds_ratio_table_log_mort30_pars_cluster.rda')
```

Random intercept model
```{r}
 log_mort30_pars_random_effect <- patients_labelled6 %>% 
  glmer(mortality30.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_mort30_pars_random_effect)
log_odds_table_log_mort30_pars_random_effect <- log_mort30_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_mort30_pars_random_effect, file='log_odds_table_log_mort30_pars_random_effect.rda')
odds_ratio_table_log_mort30_pars_random_effect <- log_mort30_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_mort30_pars_random_effect, file='odds_ratio_table_log_mort30_pars_random_effect.rda')
```


### 60 day mortality
Single-level logistic regression (without cluster SEs)
```{r}
log_mort60_pars <- glm(mortality60.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss,
                data = patients_labelled6,
                family = "binomial")

summary(log_mort60_pars)
log_odds_table_log_mort60_pars <- log_mort60_pars %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_mort60_pars, file='log_odds_table_log_mort60_pars.rda')
odds_ratio_table_log_mort60_pars <- log_mort60_pars %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_mort60_pars, file='odds_ratio_table_log_mort60_pars.rda')
av_marg_eff_log_mort60_pars <- margins(log_mort60_pars, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
log_mort60_pars_cluster <- coeftest(log_mort60_pars, vcov = vcovCL, cluster = ~ SiteCode)
log_mort60_pars_cluster
log_odds_table_log_mort60_pars_cluster <- log_mort60_pars_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_mort60_pars_cluster, file='log_odds_table_log_mort60_pars_cluster.rda')
odds_ratio_table_log_mort60_pars_cluster <- log_odds_table_log_mort60_pars_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_mort60_pars_cluster, file='odds_ratio_table_log_mort60_pars_cluster.rda')
```

Random intercept model
```{r}
 log_mort60_pars_random_effect <- patients_labelled6 %>% 
  glmer(mortality60.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_mort60_pars_random_effect)
log_odds_table_log_mort60_pars_random_effect <- log_mort60_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_mort60_pars_random_effect, file='log_odds_table_log_mort60_pars_random_effect.rda')
odds_ratio_table_log_mort60_pars_random_effect <- log_mort60_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_mort60_pars_random_effect, file='odds_ratio_table_log_mort60_pars_random_effect.rda')
```

### Combine results into tables
```{r}
# POMS
a <- log_odds_table_log_poms_pars[2,]
b <- log_odds_table_log_poms_pars_cluster[2,]
c <- log_odds_table_log_poms_pars_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_POMS_unadj[2,]


poms_pars_model_log_odds_est <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(poms_pars_model_log_odds_est, file='poms_pars_model_log_odds_est.rda')

## mort 30
a <- log_odds_table_log_mort30_pars[2,]
b <- log_odds_table_log_mort30_pars_cluster[2,]
c <- log_odds_table_log_mort30_pars_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_mort30_unadj[2,]

mort30_pars_model_log_odds_est <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(mort30_pars_model_log_odds_est, file='mort30_pars_model_log_odds_est.rda')

#60 day mortality

a <- log_odds_table_log_mort60_pars[2,]
b <- log_odds_table_log_mort60_pars_cluster[2,]
c <- log_odds_table_log_mort60_pars_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_mort60_unadj[2,]

mort60_pars_model_log_odds_est <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(mort60_pars_model_log_odds_est, file='mort60_pars_model_log_odds_est.rda')

# Collect the marginal effects into a table
marginal_effects_table_pars_log_reg <- rbind(av_marg_eff_log_poms_pars, av_marg_eff_log_mort30_pars, av_marg_eff_log_mort60_pars) %>% 
  mutate(model = c('POMS','mort30','mort60')) 
save(marginal_effects_table_pars_log_reg, file='marginal_effects_table_pars_log_reg.rda')
```

### Post-op LOS
```{r}
log_los_mv_pars <- glm.nb(S07PostopLOS ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest.factor + S04BloodLoss,  
                  data = patients_labelled6)

log_odds_table_log_los_mv_pars <- log_los_mv_pars %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_los_mv_pars, file='log_odds_table_log_los_mv_pars.rda')
odds_ratio_table_log_los_mv_pars <- log_los_mv_pars %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_los_mv_pars, file='odds_ratio_table_log_los_mv_pars.rda')
```

## IV analysis
Load in results of IV analysis from Stata with non-imputed data (run the Stata script "SNAP2_IV_Complete_Case_Analyses_Stata" to obtain the results which are loaded in here)
```{r}
CCU_IV_POMS_pars_mv <- read_excel("CCU_IV_POMS_pars_mv.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 

## Combine into table
a <- CCU_IV_POMS_pars_mv[c(2),]

bivariate_probit_results_pars_mv <- a %>% 
  mutate(outcome = c("POMS")) %>% 
  dplyr::select("outcome", everything()) %>% 
  mutate(outcome = factor(outcome) %>% 
  fct_relevel("POMS"))

save(bivariate_probit_results_pars_mv, file='bivariate_probit_results_pars_mv.rda')
```

## Plot results

### Regression results
```{r}
# Add an indicator to the results tables made earlier to signify which outcome the table refers to.
poms_pars_model_log_odds_est <- poms_pars_model_log_odds_est %>% 
  mutate(variable = "POMS") 
poms_pars_model_log_odds_est$model <-  paste("POMS", poms_pars_model_log_odds_est$model, sep="_")

mort30_pars_model_log_odds_est <- mort30_pars_model_log_odds_est %>% 
  mutate(variable = "Mort30")
mort30_pars_model_log_odds_est$model <-  paste("Mort30", mort30_pars_model_log_odds_est$model, sep="_")

mort60_pars_model_log_odds_est <- mort60_pars_model_log_odds_est %>% 
  mutate(variable = "Mort60")
mort60_pars_model_log_odds_est$model <-  paste("Mort60", mort60_pars_model_log_odds_est$model, sep="_")

# Combine the results for the various outcomes into one table
log_odds_est_all_outcomes <- rbind(poms_pars_model_log_odds_est, mort30_pars_model_log_odds_est , mort60_pars_model_log_odds_est) %>% 
  mutate(variable = factor(variable)) %>% 
  mutate(model = factor(model)) %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) 

# Recode the variables before plotting to make it more interpretable
log_odds_est_all_outcomes <- log_odds_est_all_outcomes %>% 
  filter(model == "POMS_Unadjusted logistic regression" | model == "POMS_Random intercept model" | model == "Mort30_Unadjusted logistic regression" | model == "Mort30_Random intercept model" | model == "Mort60_Unadjusted logistic regression" | model == "Mort60_Random intercept model") %>% 
  mutate(Model = fct_recode(model, 
                          "Unadjusted regression (POMS)" = "POMS_Unadjusted logistic regression", 
                          "Multilevel multivariable regression (POMS)" = "POMS_Random intercept model",
                          "Unadjusted regression (30 day mortality)" = "Mort30_Unadjusted logistic regression", 
                          "Multilevel multivariable regression (30 day mortality)" = "Mort30_Random intercept model",
                          "Unadjusted regression (60 day mortality)" = "Mort60_Unadjusted logistic regression", 
                          "Multilevel multivariable regression (60 day mortality)" = "Mort60_Random intercept model") %>% fct_relevel("Unadjusted regression (POMS)", "Multilevel multivariable regression (POMS)", "Unadjusted regression (30 day mortality)", "Multilevel multivariable regression (30 day mortality)" , "Unadjusted regression (60 day mortality)", "Multilevel multivariable regression (60 day mortality)")) %>% 
  mutate(Outcome = fct_recode(variable,
                              "POMS" = "POMS",
                              "30 day mortality" = "Mort30",
                              "60 day mortality" = "Mort60"))

# Plot the results for the various outcomes in the regression analyses
log_odds_est_all_outcomes_regression_plot <-
  ggplot(log_odds_est_all_outcomes, aes(Model, or_est)) +  
  geom_point(aes(colour = Outcome), pch = 19) +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95, colour = Outcome)) +
  scale_y_continuous(trans='log10') + 
  expand_limits(y = 0.5) +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("Analysis") +
  ylab("Odds Ratio (log scale)") + 
  theme_classic() +
  scale_color_manual(values = c("POMS" = "black",
                                "30 day mortality"="#0c385c",
                                "60 day mortality"="#1770b8")) +
  theme(plot.title=element_text(size=10)) +
  ggtitle("Complete case analysis - logistic regresson results for all outcomes") +
  theme(legend.position="none") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))
```

### Plot IV with Regression results
Note that only POMS outcome is plotted with IV results. For mortality estimates, only the regression results are plotted (IV analyses were not possible with mortality due to the low incidence of outcomes)
```{r}
# POMS
## Odds ratios
load('poms_pars_model_log_odds_est.rda')
iv_results_row <- c("Bivariate Probit", "icu_adm.factorTRUE", "", "", "", "", "", "", 0.9811726,	0.598903537,	1.607437)  # taken from bivariate_probit_results_pars_mv.rda
age_cat_y1 <- poms_pars_model_log_odds_est %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high))
age_cat_y1 <- rbind(age_cat_y1,iv_results_row) %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) %>% 
         mutate(model = factor(model) %>%
  fct_relevel("Unadjusted logistic regression","Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Bivariate Probit"))


POMS_all_results_plot <- ggplot(age_cat_y1, aes(model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("POMS all results (Complete Case)")

age_cat_y1_pub <- age_cat_y1 %>% 
  filter(model == "Bivariate Probit" | model == "Random intercept model" |  model == "Unadjusted logistic regression") %>% 
  mutate(Model = fct_recode(model, 
                          "Unadjusted regression" = "Unadjusted logistic regression", 
                          "Multilevel multivariable regression" = "Random intercept model",
                          "Bivariate Probit IV analysis" = "Bivariate Probit")) 
  
  
POMS_all_results_plot_publication <- ggplot(age_cat_y1_pub, aes(Model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("Analysis") +
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("") + 
  expand_limits(y = 0.5) +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))

### Average Treatment effects (aka marginal effects)
 
a <- marginal_effects_table_pars_log_reg[1,]
b <- c("icu_adm.factorTRUE", -0.002, 0.031, -0.08, 0.940, -0.062, 0.058, "Bivariate Probit IV analysis") # ATE results are obtained when running the Stata script above. Results are manually copied across from Stata.

POMS_marginal_effects_results <- rbind(a,b) %>%  
  dplyr::select("model", everything()) %>% 
  mutate(model = factor(model) %>% 
  fct_relevel("POMS","Bivariate Probit IV analysis") %>% 
  fct_recode(
    "One-stage Logistic regression" = "POMS"
  )) %>%  
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))

## Plot mv logistic regression vs Bivariate probit
POMS_marginal_effects_results_plot <- 
  ggplot(POMS_marginal_effects_results, aes(model, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("POMS marginal effects results (Complete Case)")

## Plot unadj logistic regression vs mv logistic regression vs Bivariate probit
a <- av_marg_eff_POMS_unadj %>% mutate(Analysis = "Unadjusted regression")
b <- marginal_effects_table_pars_log_reg[1,c(1,2,3,4,5,6,7)] %>%  mutate(Analysis = "Multilevel multivariable regression")
ame_log_reg <- rbind(a,b)
c <- c("icu_adm.factorTRUE", -0.002, 0.031, -0.08, 0.940, -0.062, 0.058, "Bivariate Probit IV analysis")

ame_iv_log_combined <- rbind(ame_log_reg, c) %>% 
  mutate(AME = as.numeric(AME),
           lower = as.numeric(lower),
         upper = as.numeric(upper)) %>% 
  mutate(Analysis = factor(Analysis) %>% 
           fct_relevel("Unadjusted regression", "Multilevel multivariable regression", "Bivariate Probit IV analysis"))

POMS_marginal_effects_results_iv_log_combined_plot <- ggplot(ame_iv_log_combined, aes(Analysis, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("") + 
  expand_limits(y=-0.1) + 
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))

# Combine POMS plots together for publication
combined_poms_pub_plot <- POMS_all_results_plot_publication / POMS_marginal_effects_results_iv_log_combined_plot 
combined_poms_pub_plot <- combined_poms_pub_plot + plot_annotation(tag_levels = 'a')


# 30 day mortality 
## Odds ratios
load('mort30_pars_model_log_odds_est.rda')
age_cat_y2 <- mort30_pars_model_log_odds_est %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high))
age_cat_y2 <-   age_cat_y2 %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) %>% 
         mutate(model = factor(model) %>%
  fct_relevel("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model"))


mort30_all_results_plot <- ggplot(age_cat_y2, aes(model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("30 day mortality all results (Complete Case)")

### Average Treatment effects (aka marginal effects)
 
a <- marginal_effects_table_pars_log_reg[2,]

mort30_marginal_effects_results <- a %>%  
  dplyr::select("model", everything()) %>% 
  mutate(model = factor(model) %>% 
  fct_relevel("mort30")) %>% 
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))

mort30_marginal_effects_results_plot <- ggplot(mort30_marginal_effects_results, aes(model, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("Mort30 marginal effects results (Complete Case)")

# 60 day mortality 
## Odds ratios
load('mort60_pars_model_log_odds_est.rda')
age_cat_y3 <- mort60_pars_model_log_odds_est %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high))
age_cat_y3 <-   age_cat_y3 %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) %>% 
         mutate(model = factor(model) %>%
  fct_relevel("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model"))


mort60_all_results_plot <- ggplot(age_cat_y3, aes(model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("60 day mortality all results (Complete Case)")

### Average Treatment effects (aka marginal effects)
 
a <- marginal_effects_table_pars_log_reg[3,]

mort60_marginal_effects_results <- a %>%  
  dplyr::select("model", everything()) %>% 
  mutate(model = factor(model) %>% 
  fct_relevel("mort60")) %>% 
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))

mort60_marginal_effects_results_plot <- ggplot(mort60_marginal_effects_results , aes(model, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("Mort60 marginal effects results (Complete Case)")

```

# Sensitivity Analysis 3: Planned CCU admissions only

Create dataset of only 'planned' CCU admissions
```{r}
planned_icu_only_imputed <- patients_labelled6_imputed %>% 
  filter(S07UnplannedDayOfSurgeryIcuHduPacuAdmission == "N" | is.na(S07UnplannedDayOfSurgeryIcuHduPacuAdmission))
# 211 patients excluded

save(planned_icu_only_imputed, file = 'planned_icu_only_imputed.rda')
load(file = 'planned_icu_only_imputed.rda')

# write dta file for stata
planned_icu_only_imputed_dta <- planned_icu_only_imputed %>% 
  dplyr::select(c(CCUCapacityTimeofSurgCat, CCUCapacityTimeofSurgery, EmptyBedsTimeofSurgery, EmptyBedsTimeofSurgCat, POMS, POMS.factor, icu_adm.factor  , S01Gender  , Age_scaled  , age_p10, weekend.factor  ,  S02OperativeUrgency  , S02PlannedProcSeverity  , asa  ,  PreopLOS.factor  ,  combined_DHx  , combined_PMHx  , diabetes.factor  ,  sysBP_scaled  , HR_scaled  ,  Anaesthetist_grade_combined.factor  , Surgeon_grade_combined.factor , abnormal_bloodtest_impute_normal.factor , S04BloodLoss, SiteCode))
write.dta(planned_icu_only_imputed_dta, "planned_icu_only_imputed_dta.dta")
```

## Part 1 - Test whether the probability of admission to Critical Care is affected by bed availablity
In the first part of this analysis, we use a multivariable logistic regression analysis to investigate the above question. We construct two models: one including only patient-level variables, as well as patient-level variables and hospital-level variables. These two models then have the MOR calculated for them to investigate how the addition of these variables explains the variability between hospital sites (these MORs are compared to the random-intercept only model calculated in the previous section). 

## Run the MV regression for probability of Critical care admission depending on bed availability (including only patient-level variables, as well as patient-level variables and hospital-level variables). Also check how this affects the variability between hospital sites.
```{r}
# Run Empty "Intercept-only" model to get unadjusted MOR between hospitals
planned_only_empty_random_effects_icu_adm <- planned_icu_only_imputed %>% 
  glmer(icu_adm.factor ~ (1 | SiteCode), data =., family = "binomial")

summary(planned_only_empty_random_effects_icu_adm )
odds_ratio_table_planned_only_empty_random_effects_icu_adm <- planned_only_empty_random_effects_icu_adm %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_planned_only_empty_random_effects_icu_adm, file = 'odds_ratio_table_planned_only_empty_random_effects_icu_adm.rda')
random_parameters(planned_only_empty_random_effects_icu_adm )
# variance = 1.18
my.var_planned_only_empty_random_effects_icu_adm  <- 1.18 
MOR_planned_only_empty_random_effects_icu_adm  <- my.var_planned_only_empty_random_effects_icu_adm %>% MOR() 


# run mv logistic regression including patient-level effects
planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include <- planned_icu_only_imputed %>% 
  filter(!(specialty.factor == "Other")) %>% 
  glmer(icu_adm.factor ~ CCUCapacityTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + specialty.factor + S04CriticalUnexpectedEventsPerioperatively + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

summary(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include) 
log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include <- planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include, file='log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include.rda')
odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include <- planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include, file='odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include.rda')

random_parameters(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include)
my.var_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include <- 1.56 
MOR_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include <- my.var_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include %>% MOR() 

# run regression including patient-level effects and hospital-level variable (i.e. total icu capacity)
planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include <- planned_icu_only_imputed %>% 
  filter(!(specialty.factor == "Other")) %>% 
  glmer(icu_adm.factor ~ CCUCapacityTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + specialty.factor + S04CriticalUnexpectedEventsPerioperatively + TotalCapacityTimeofSurgery + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

summary(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include) 
log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include <- planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include, file='log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include.rda')
odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include <- planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include, file='odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include.rda')

random_parameters(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include)
my.var_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include <- 1.56 
MOR_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include <- my.var_planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include %>% MOR() 

# Plot the model with patient-level effects only
planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include_plot <- plot_model(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include, 
           rm.terms = c("age_p10.L", 
                       "age_p10.Q", 
                       "age_p10.C",
                      "age_p10^4", 
                       "age_p10^5", 
                       "age_p10^6"),
           show.p = TRUE, show.values = TRUE, value.offset = 0.4, value.size = 3, vline.color = "red", 
           title = "") +
  scale_x_discrete(labels=list(
    CCUCapacityTimeofSurgery = "Available CCU beds at time of surgery",
    S01GenderMale = "Sex : Male", 
    weekend.factorWeekend = "Weekend surgery",
    S02OperativeUrgencyExpedited = "Operative Urgency : Expedited",
    S02OperativeUrgencyUrgent = "Operative Urgency : Urgent", 
    S02OperativeUrgencyImmediate = "Operative Urgency : Immediate",
    S02PlannedProcSeverityIntermediate = "Procedure Severity : Intermediate",
    S02PlannedProcSeverityMajor = "Procedure Severity : Major", 
    S02PlannedProcSeverityXMajor = "Procedure Severity : XMajor",
    S02PlannedProcSeverityComplex = "Procedure Severity : Complex",
    asaII = "ASA II", 
    asaIII = "ASA III",
    'asaIV/V' = "ASA IV/V",
    PreopLOS.factor1 = "Preoperative Length of Stay : 1 day",
    'PreopLOS.factor2 to 6' = "Preoperative Length of Stay : 2 to 6 days", 
    'PreopLOS.factor7 to 20' = "Preoperative Length of Stay : 7 to 20 days",
    'PreopLOS.factor21 to 251' = "Preoperative Length of Stay : 21+ days",
    combined_DHxTrue = "Positive drug history for listed medications", 
    combined_PMHxTrue = "Positive past medical history of listed conditions",
    'diabetes.factorT2DM - Diet Controlled' = "Diabetes : T2DM - Diet controlled",
    'diabetes.factorT2DM - Oral medication' = "Diabetes : T2DM - Oral medication",
    'diabetes.factorT2DM - Insulin controlled' = "Diabetes : T2DM - Insulin controlled",
    'diabetes.factorT1DM' = "Diabetes : T1DM",
    sysBP_scaled = "Pre-induction systolic BP (scaled)",
    HR_scaled = "Pre-induction heart rate (scaled)",
    'Anaesthetist_grade_combined.factorNon-consultant' = "Grade of most senior Anaesthetist : Non-consultant",
    'Surgeon_grade_combined.factorNon-consultant' = "Grade of most senior Surgeon : Non-consultant",
    abnormal_bloodtest_impute_normal.factor1 = "Abnormality on preoperative blood test",
    'S04BloodLoss101-500ml' = "Estimated blood loss : 101-500mls",
    'S04BloodLoss501-999ml' = "Estimated blood loss : 501-999mls",
    'S04BloodLoss>1000ml' = "Estimated blood loss : > 1000mls", 
    specialty.factorBreast = "Surgical specialty : Breast", 
    specialty.factorCardiology = "Surgical specialty : Cardiology",
    specialty.factorColorectal = "Surgical specialty : Colorectal",
    specialty.factorEndocrine = "Surgical specialty : Endocrine",
    specialty.factorEndoscopic = "Surgical specialty : Endoscopic",
    specialty.factorENT = "Surgical specialty : ENT",
    specialty.factorGynae = "Surgical specialty : Gynaecology",
    specialty.factorHPB = "Surgical specialty : HPB",
    specialty.factorIR = "Surgical specialty : Interventional Radiology",
    'specialty.factorMaxFax-Dental' = "Surgical specialty : Max-Fax/Dental",
    specialty.factorOpthalmic = "Surgical specialty : Opthalmic",
    specialty.factorOrtho = "Surgical specialty : Orthopaedics",
    specialty.factorPlastics = "Surgical specialty : Plastic Surgery",
    specialty.factorSpine = "Surgical specialty : Spine",
    specialty.factorThoracic = "Surgical specialty : Thoracic",
    specialty.factorTransplant = "Surgical specialty : Transplant",
    specialty.factorUpperGI = "Surgical specialty : Upper GI",
    specialty.factorUrology = "Surgical specialty : Urology",
    specialty.factorVascular = "Surgical specialty : Vascular",
    S04CriticalUnexpectedEventsPerioperativelyTrue = "Critical Unexpected Events Perioperatively : True"
  )) + 
  scale_y_continuous(trans='log10') +
  ylab("Odds Ratio") +
  xlab("Model feature") +
  theme_classic() +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))

```

## Check if critical care capacity remains significant when model is restricted to the features included in the IV analysis models
This analyses uses the same model features as the models investigating the effect of critical care admission on outcomes. This is a subset of the features in the above models (specialty and critical adverse events are removed). 
- This is done as the model features need to be identical in both equations in the Instrumental variable analyses. Therefore it was necessary to check that, using these model features, there was a statistically significant effect of Critical care capacity on probability of admission - to permit it's inclusion as a valid instrument. 
- The reasons for the narrowed feature set was that, although specialty and critical adverse events were relevant for one's probability of admission, the effect was less important for outcomes - and so they added extra, unnecessary dimensionality to the model with little explanatory power.
```{r}
## Random effects model
 planned_icu_only_imputed_log_ccu_pars_random_effect <- planned_icu_only_imputed %>% 
  glmer(icu_adm.factor ~ CCUCapacityTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( planned_icu_only_imputed_log_ccu_pars_random_effect)
log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect <- planned_icu_only_imputed_log_ccu_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect, file='log_odds_table_planned_icu_only_imputed_log_ccu_pars_random_effect.rda')
odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect <- planned_icu_only_imputed_log_ccu_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect, file='odds_ratio_table_planned_icu_only_imputed_log_ccu_pars_random_effect.rda')

```

## Part 2 - Evaluate the effect of postoperative Critical Care admission on Outcomes
## Unadjusted analyses
### Primary outcome: POMS
```{r, results=TRUE}
planned_icu_only_imputed_log_poms <- glm(POMS.factor ~ icu_adm.factor,
                data = planned_icu_only_imputed,
                family = "binomial")

log_odds_table_planned_icu_only_imputed_log_poms <- planned_icu_only_imputed_log_poms %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_poms, file='log_odds_table_planned_icu_only_imputed_log_poms.rda')
odds_ratio_table_planned_icu_only_imputed_log_poms <- planned_icu_only_imputed_log_poms %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_poms, file='odds_ratio_table_planned_icu_only_imputed_log_poms.rda')
av_marg_eff_planned_icu_only_imputed_log_poms <- margins(planned_icu_only_imputed_log_poms, variables = c("icu_adm.factor")) %>% summary()

```

### Secondary outcomes: Mortality

```{r}
# 30 day
planned_icu_only_imputed_log_mort30 <- glm(mortality30.factor ~ icu_adm.factor,
                data = planned_icu_only_imputed,
                family = "binomial")

log_odds_table_planned_icu_only_imputed_log_mort30 <- planned_icu_only_imputed_log_mort30 %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort30, file='log_odds_table_planned_icu_only_imputed_log_mort30.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort30 <- planned_icu_only_imputed_log_mort30 %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_mort30, file='odds_ratio_table_planned_icu_only_imputed_log_mort30.rda')
av_marg_eff_planned_icu_only_imputed_log_mort30 <- margins(planned_icu_only_imputed_log_mort30, variables = c("icu_adm.factor")) %>% summary()

# 60 day
planned_icu_only_imputed_log_mort60 <- glm(mortality60.factor ~ icu_adm.factor,
                data = planned_icu_only_imputed,
                family = "binomial")

log_odds_table_planned_icu_only_imputed_log_mort60 <- planned_icu_only_imputed_log_mort60 %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort60, file='log_odds_table_planned_icu_only_imputed_log_mort60.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort60 <- planned_icu_only_imputed_log_mort60 %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_mort60, file='odds_ratio_table_planned_icu_only_imputed_log_mort60.rda')
av_marg_eff_planned_icu_only_imputed_log_mort60 <- margins(planned_icu_only_imputed_log_mort60, variables = c("icu_adm.factor")) %>% summary()
```

### Secondary outcome: LOS
```{r}
# Negative binomial regression used for count data
planned_icu_only_imputed_log_los_unadj <- glm.nb(S07PostopLOS ~ icu_adm.factor, data = planned_icu_only_imputed)
planned_icu_only_imputed_log_los_unadj %>% tidy(conf.int = TRUE, exp = TRUE)

```

## Adjusted analyses
For the adjusted analyses, 3 regression models were run for each outcome: A single-level logistic regression (i.e. without clustering on hospital site), A single-level logistic regression with cluster robust Std Errors (using hospital site as the cluster to adjust the Std Errors on), A multi-level (aka random effects) logistic regression with clustering by hospital site. This was done to compare the results between the different approaches. 
- For the purposes of publication, the multi-level logistic regression was chosen as the most appropriate model to report results for. 

### POMS
Single-level logistic regression (without cluster SEs)
```{r}
planned_icu_only_imputed_log_poms_pars <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = planned_icu_only_imputed,
                family = "binomial")

summary(planned_icu_only_imputed_log_poms_pars)
log_odds_table_planned_icu_only_imputed_log_poms_pars <- planned_icu_only_imputed_log_poms_pars %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_poms_pars, file='log_odds_table_planned_icu_only_imputed_log_poms_pars.rda')
odds_ratio_table_planned_icu_only_imputed_log_poms_pars <- planned_icu_only_imputed_log_poms_pars %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_poms_pars, file='odds_ratio_table_planned_icu_only_imputed_log_poms_pars.rda')
av_marg_eff_planned_icu_only_imputed_log_poms_pars <- margins(planned_icu_only_imputed_log_poms_pars, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
planned_icu_only_imputed_log_poms_pars_cluster <- coeftest(planned_icu_only_imputed_log_poms_pars, vcov = vcovCL, cluster = ~ SiteCode)
planned_icu_only_imputed_log_poms_pars_cluster # as expected the SEs are larger
log_odds_table_planned_icu_only_imputed_log_poms_pars_cluster <- planned_icu_only_imputed_log_poms_pars_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_poms_pars_cluster, file='log_odds_table_planned_icu_only_imputed_log_poms_pars_cluster.rda')
odds_ratio_table_planned_icu_only_imputed_log_poms_pars_cluster <- log_odds_table_planned_icu_only_imputed_log_poms_pars_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_planned_icu_only_imputed_log_poms_pars_cluster, file='odds_ratio_table_planned_icu_only_imputed_log_poms_pars_cluster.rda')
```

Random intercept model
```{r}

 planned_icu_only_imputed_log_poms_pars_random_effect <- planned_icu_only_imputed %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( planned_icu_only_imputed_log_poms_pars_random_effect)
log_odds_table_planned_icu_only_imputed_log_poms_pars_random_effect <- planned_icu_only_imputed_log_poms_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_poms_pars_random_effect, file='log_odds_table_planned_icu_only_imputed_log_poms_pars_random_effect.rda')
odds_ratio_table_planned_icu_only_imputed_log_poms_pars_random_effect <- planned_icu_only_imputed_log_poms_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_poms_pars_random_effect, file='odds_ratio_table_planned_icu_only_imputed_log_poms_pars_random_effect.rda')
```


### 30 day mortality
Single-level logistic regression (without cluster SEs)
```{r}
planned_icu_only_imputed_log_mort30_pars <- glm(mortality30.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = planned_icu_only_imputed,
                family = "binomial")

summary(planned_icu_only_imputed_log_mort30_pars)
log_odds_table_planned_icu_only_imputed_log_mort30_pars <- planned_icu_only_imputed_log_mort30_pars %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort30_pars, file='log_odds_table_planned_icu_only_imputed_log_mort30_pars.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort30_pars <- planned_icu_only_imputed_log_mort30_pars %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_mort30_pars, file='odds_ratio_table_planned_icu_only_imputed_log_mort30_pars.rda')
av_marg_eff_planned_icu_only_imputed_log_mort30_pars <- margins(planned_icu_only_imputed_log_mort30_pars, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
planned_icu_only_imputed_log_mort30_pars_cluster <- coeftest(planned_icu_only_imputed_log_mort30_pars, vcov = vcovCL, cluster = ~ SiteCode)
planned_icu_only_imputed_log_mort30_pars_cluster
log_odds_table_planned_icu_only_imputed_log_mort30_pars_cluster <- planned_icu_only_imputed_log_mort30_pars_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort30_pars_cluster, file='log_odds_table_planned_icu_only_imputed_log_mort30_pars_cluster.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort30_pars_cluster <- log_odds_table_planned_icu_only_imputed_log_mort30_pars_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_planned_icu_only_imputed_log_mort30_pars_cluster, file='odds_ratio_table_planned_icu_only_imputed_log_mort30_pars_cluster.rda')
```

Random intercept model
```{r}
 planned_icu_only_imputed_log_mort30_pars_random_effect <- planned_icu_only_imputed %>% 
  glmer(mortality30.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( planned_icu_only_imputed_log_mort30_pars_random_effect)
log_odds_table_planned_icu_only_imputed_log_mort30_pars_random_effect <- planned_icu_only_imputed_log_mort30_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort30_pars_random_effect, file='log_odds_table_planned_icu_only_imputed_log_mort30_pars_random_effect.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort30_pars_random_effect <- planned_icu_only_imputed_log_mort30_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_mort30_pars_random_effect, file='odds_ratio_table_planned_icu_only_imputed_log_mort30_pars_random_effect.rda')
```


### 60 day mortality
Single-level logistic regression (without cluster SEs)
```{r}
planned_icu_only_imputed_log_mort60_pars <- glm(mortality60.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = planned_icu_only_imputed,
                family = "binomial")

summary(planned_icu_only_imputed_log_mort60_pars)
log_odds_table_planned_icu_only_imputed_log_mort60_pars <- planned_icu_only_imputed_log_mort60_pars %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort60_pars, file='log_odds_table_planned_icu_only_imputed_log_mort60_pars.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort60_pars <- planned_icu_only_imputed_log_mort60_pars %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_mort60_pars, file='odds_ratio_table_planned_icu_only_imputed_log_mort60_pars.rda')
av_marg_eff_planned_icu_only_imputed_log_mort60_pars <- margins(planned_icu_only_imputed_log_mort60_pars, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
planned_icu_only_imputed_log_mort60_pars_cluster <- coeftest(planned_icu_only_imputed_log_mort60_pars, vcov = vcovCL, cluster = ~ SiteCode)
planned_icu_only_imputed_log_mort60_pars_cluster
log_odds_table_planned_icu_only_imputed_log_mort60_pars_cluster <- planned_icu_only_imputed_log_mort60_pars_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort60_pars_cluster, file='log_odds_table_planned_icu_only_imputed_log_mort60_pars_cluster.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort60_pars_cluster <- log_odds_table_planned_icu_only_imputed_log_mort60_pars_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_planned_icu_only_imputed_log_mort60_pars_cluster, file='odds_ratio_table_planned_icu_only_imputed_log_mort60_pars_cluster.rda')
```

Random intercept model
```{r}
 planned_icu_only_imputed_log_mort60_pars_random_effect <- planned_icu_only_imputed %>% 
  glmer(mortality60.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( planned_icu_only_imputed_log_mort60_pars_random_effect)
log_odds_table_planned_icu_only_imputed_log_mort60_pars_random_effect <- planned_icu_only_imputed_log_mort60_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_planned_icu_only_imputed_log_mort60_pars_random_effect, file='log_odds_table_planned_icu_only_imputed_log_mort60_pars_random_effect.rda')
odds_ratio_table_planned_icu_only_imputed_log_mort60_pars_random_effect <- planned_icu_only_imputed_log_mort60_pars_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_planned_icu_only_imputed_log_mort60_pars_random_effect, file='odds_ratio_table_planned_icu_only_imputed_log_mort60_pars_random_effect.rda')
```

## Combine results into tables
```{r}
# POMS
a <- log_odds_table_planned_icu_only_imputed_log_poms_pars[2,]
b <- log_odds_table_planned_icu_only_imputed_log_poms_pars_cluster[2,]
c <- log_odds_table_planned_icu_only_imputed_log_poms_pars_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_planned_icu_only_imputed_log_poms[2,]

planned_icu_only_imputed_poms_pars_model_log_odds_est <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(planned_icu_only_imputed_poms_pars_model_log_odds_est, file='planned_icu_only_imputed_poms_pars_model_log_odds_est.rda')

## mort 30
a <- log_odds_table_planned_icu_only_imputed_log_mort30_pars[2,]
b <- log_odds_table_planned_icu_only_imputed_log_mort30_pars_cluster[2,]
c <- log_odds_table_planned_icu_only_imputed_log_mort30_pars_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_planned_icu_only_imputed_log_mort30[2,]

planned_icu_only_imputed_mort30_pars_model_log_odds_est <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(planned_icu_only_imputed_mort30_pars_model_log_odds_est, file='planned_icu_only_imputed_mort30_pars_model_log_odds_est.rda')

#60 day mortality

a <- log_odds_table_planned_icu_only_imputed_log_mort60_pars[2,]
b <- log_odds_table_planned_icu_only_imputed_log_mort60_pars_cluster[2,]
c <- log_odds_table_planned_icu_only_imputed_log_mort60_pars_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_planned_icu_only_imputed_log_mort60[2,]

planned_icu_only_imputed_mort60_pars_model_log_odds_est <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(planned_icu_only_imputed_mort60_pars_model_log_odds_est, file='planned_icu_only_imputed_mort60_pars_model_log_odds_est.rda')

# Collect the marginal effects into a table
planned_icu_only_imputed_marginal_effects_table_pars_log_reg <- rbind(av_marg_eff_planned_icu_only_imputed_log_poms_pars, av_marg_eff_planned_icu_only_imputed_log_mort30_pars, av_marg_eff_planned_icu_only_imputed_log_mort60_pars) %>% 
  mutate(model = c('POMS','mort30','mort60')) 
save(planned_icu_only_imputed_marginal_effects_table_pars_log_reg, file='planned_icu_only_imputed_marginal_effects_table_pars_log_reg.rda')
```

### Post-op LOS
```{r}

planned_icu_only_imputed_log_los_mv_pars <- glm.nb(S07PostopLOS ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,  
                  data = planned_icu_only_imputed)

log_odds_table_planned_icu_only_imputed_log_los_mv_pars <- planned_icu_only_imputed_log_los_mv_pars %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_planned_icu_only_imputed_log_los_mv_pars, file='planned_icu_only_imputed_log_odds_table_log_los_mv_pars.rda')
odds_ratio_table_planned_icu_only_imputed_log_los_mv_pars <- planned_icu_only_imputed_log_los_mv_pars %>% tidy(conf.int = TRUE, exp = TRUE)  
save(odds_ratio_table_planned_icu_only_imputed_log_los_mv_pars, file='odds_ratio_table_planned_icu_only_imputed_log_los_mv_pars.rda')

```


## IV results
Load in results of IV analysis from Stata (run the Stata script "SNAP2_IV_Planned_CCU_Only_Stata" to obtain the results which are loaded in here)
```{r}
CCU_IV_POMS_planned_icu_only_imputed <- read_excel("CCU_IV_POMS_planned_icu_only_imputed.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 

## Combine into table
a <- CCU_IV_POMS_planned_icu_only_imputed[c(2),]

bivariate_probit_results_planned_icu_only_imputed <- CCU_IV_POMS_planned_icu_only_imputed[c(2),] %>% 
  mutate(outcome = c("POMS")) %>% 
  dplyr::select("outcome", everything()) %>% 
  mutate(outcome = factor(outcome))

save(bivariate_probit_results_planned_icu_only_imputed, file='bivariate_probit_results_planned_icu_only_imputed.rda')

```

## Plot results

### Regression results
```{r}
# Add an indicator to the results tables made earlier to signify which outcome the table refers to.
planned_icu_only_imputed_poms_pars_model_log_odds_est <- planned_icu_only_imputed_poms_pars_model_log_odds_est %>% 
  mutate(variable = "POMS") 
planned_icu_only_imputed_poms_pars_model_log_odds_est$model <-  paste("POMS", planned_icu_only_imputed_poms_pars_model_log_odds_est$model, sep="_")

planned_icu_only_imputed_mort30_pars_model_log_odds_est <- planned_icu_only_imputed_mort30_pars_model_log_odds_est %>% 
  mutate(variable = "Mort30")
planned_icu_only_imputed_mort30_pars_model_log_odds_est$model <-  paste("Mort30", planned_icu_only_imputed_mort30_pars_model_log_odds_est$model, sep="_")

planned_icu_only_imputed_mort60_pars_model_log_odds_est <- planned_icu_only_imputed_mort60_pars_model_log_odds_est %>% 
  mutate(variable = "Mort60")
planned_icu_only_imputed_mort60_pars_model_log_odds_est$model <-  paste("Mort60", planned_icu_only_imputed_mort60_pars_model_log_odds_est$model, sep="_")

# Combine the results for the various outcomes into one table
planned_icu_only_imputed_log_odds_est_all_outcomes <- rbind(planned_icu_only_imputed_poms_pars_model_log_odds_est, planned_icu_only_imputed_mort30_pars_model_log_odds_est , planned_icu_only_imputed_mort60_pars_model_log_odds_est) %>% 
  mutate(variable = factor(variable)) %>% 
  mutate(model = factor(model)) %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) 

# Recode the variables before plotting to make it more interpretable
planned_icu_only_imputed_log_odds_est_all_outcomes <- planned_icu_only_imputed_log_odds_est_all_outcomes %>% 
  filter(model == "POMS_Unadjusted logistic regression" | model == "POMS_Random intercept model" | model == "Mort30_Unadjusted logistic regression" | model == "Mort30_Random intercept model" | model == "Mort60_Unadjusted logistic regression" | model == "Mort60_Random intercept model") %>% 
  mutate(Model = fct_recode(model, 
                          "Unadjusted regression (POMS)" = "POMS_Unadjusted logistic regression", 
                          "Multilevel multivariable regression (POMS)" = "POMS_Random intercept model",
                          "Unadjusted regression (30 day mortality)" = "Mort30_Unadjusted logistic regression", 
                          "Multilevel multivariable regression (30 day mortality)" = "Mort30_Random intercept model",
                          "Unadjusted regression (60 day mortality)" = "Mort60_Unadjusted logistic regression", 
                          "Multilevel multivariable regression (60 day mortality)" = "Mort60_Random intercept model") %>% fct_relevel("Unadjusted regression (POMS)", "Multilevel multivariable regression (POMS)", "Unadjusted regression (30 day mortality)", "Multilevel multivariable regression (30 day mortality)" , "Unadjusted regression (60 day mortality)", "Multilevel multivariable regression (60 day mortality)")) %>% 
  mutate(Outcome = fct_recode(variable,
                              "POMS" = "POMS",
                              "30 day mortality" = "Mort30",
                              "60 day mortality" = "Mort60"))

# Plot the results for the various outcomes in the regression analyses
planned_icu_only_imputed_log_odds_est_all_outcomes_regression_plot <-
  ggplot(planned_icu_only_imputed_log_odds_est_all_outcomes, aes(Model, or_est)) +  
  geom_point(aes(colour = Outcome), pch = 19) +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95, colour = Outcome)) +
  scale_y_continuous(trans='log10') + 
  expand_limits(y = 0.5) +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("Analysis") +
  ylab("Odds Ratio (log scale)") + 
  theme_classic() +
  scale_color_manual(values = c("POMS" = "black",
                                "30 day mortality"="#0c385c",
                                "60 day mortality"="#1770b8")) +
  theme(plot.title=element_text(size=10)) +
  ggtitle("") +
  theme(legend.position="none") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))
```

### Plot IV with Regression results
Note that only POMS outcome is plotted with IV results. For mortality estimates, only the regression results are plotted (IV analyses were not possible with mortality due to the low incidence of outcomes)
```{r}
# POMS
## Odds ratios
load('planned_icu_only_imputed_poms_pars_model_log_odds_est.rda')
iv_results_row <- c("Bivariate Probit", "icu_adm.factorTRUE", "", "", "", "", "", "", 0.8679841,	0.5490999,	1.372057) # taken from IV results table above
      
age_cat_y1 <- planned_icu_only_imputed_poms_pars_model_log_odds_est %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high))
age_cat_y1 <- rbind(age_cat_y1,iv_results_row) %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) %>% 
         mutate(model = factor(model) %>%
  fct_relevel("Unadjusted logistic regression","Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Bivariate Probit"))


planned_icu_only_imputed_POMS_all_results_plot <- ggplot(age_cat_y1, aes(model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("POMS all results (Planned CCU only)")

age_cat_y1_pub <- age_cat_y1 %>% 
  filter(model == "Bivariate Probit" | model == "Random intercept model" |  model == "Unadjusted logistic regression") %>% 
  mutate(Model = fct_recode(model, 
                          "Unadjusted regression" = "Unadjusted logistic regression", 
                          "Multilevel multivariable regression" = "Random intercept model",
                          "Bivariate Probit IV analysis" = "Bivariate Probit")) 
  
  
planned_icu_only_imputed_POMS_all_results_plot_publication <- ggplot(age_cat_y1_pub, aes(Model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("Analysis") +
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))

### Average Treatment effects (aka marginal effects)
 
a <- planned_icu_only_imputed_marginal_effects_table_pars_log_reg[1,]
b <- c("icu_adm.factorTRUE", -0.015, 0.024, -0.62, 0.533, -0.06, 0.03, "Bivariate Probit IV analysis")

## Plot mv logistic regression vs Bivariate probit
POMS_marginal_effects_results <- rbind(a,b) %>%  
  dplyr::select("model", everything()) %>% 
  mutate(model = factor(model) %>% 
  fct_relevel("POMS","Bivariate Probit IV analysis") %>% 
  fct_recode(
    "One-stage Logistic regression" = "POMS"
  )) %>%  
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))

planned_icu_only_imputed_POMS_marginal_effects_results_plot <- 
  ggplot(POMS_marginal_effects_results, aes(model, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("POMS marginal effects results (Planned CCU only)")

## Plot unadj logistic regression vs mv logistic regression vs Bivariate probit
a <- av_marg_eff_planned_icu_only_imputed_log_poms %>% mutate(Analysis = "Unadjusted regression")
b <- planned_icu_only_imputed_marginal_effects_table_pars_log_reg[1,c(1,2,3,4,5,6,7)] %>%  mutate(Analysis = "Multilevel multivariable regression")

ame_log_reg <- rbind(a,b)

c <- c("icu_adm.factorTRUE", -0.015, 0.024, -0.62, 0.533, -0.06, 0.03, "Bivariate Probit IV analysis")

ame_iv_log_combined <- rbind(ame_log_reg, c) %>% 
  mutate(AME = as.numeric(AME),
           lower = as.numeric(lower),
         upper = as.numeric(upper)) %>% 
  mutate(Analysis = factor(Analysis) %>% 
           fct_relevel("Unadjusted regression", "Multilevel multivariable regression", "Bivariate Probit"))

planned_icu_only_imputed_POMS_marginal_effects_results_iv_log_combined_plot <- ggplot(ame_iv_log_combined, aes(Analysis, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("") + 
  expand_limits(y = -0.1) +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))

# Combine POMS plots together for publication
combined_poms_planned_icu_only_imputed_pub_plot <- planned_icu_only_imputed_POMS_all_results_plot_publication / planned_icu_only_imputed_POMS_marginal_effects_results_iv_log_combined_plot 
combined_poms_planned_icu_only_imputed_pub_plot <- combined_poms_planned_icu_only_imputed_pub_plot + plot_annotation(tag_levels = 'a')

# 30 day mortality 
## Odds ratios
load('planned_icu_only_imputed_mort30_pars_model_log_odds_est.rda')
age_cat_y2 <- planned_icu_only_imputed_mort30_pars_model_log_odds_est %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high))
age_cat_y2 <-   age_cat_y2 %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) %>% 
         mutate(model = factor(model) %>%
  fct_relevel("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model"))


planned_icu_only_imputed_mort30_all_results_plot <- ggplot(age_cat_y2, aes(model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("30 day mortality all results (Planned CCU only)")

### Average Treatment effects (aka marginal effects)
 
a <- planned_icu_only_imputed_marginal_effects_table_pars_log_reg[2,]

planned_icu_only_imputed_mort30_marginal_effects_results <- a %>%  
  dplyr::select("model", everything()) %>% 
  mutate(model = factor(model) %>% 
  fct_relevel("mort30")) %>% 
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))

planned_icu_only_imputed_mort30_marginal_effects_results_plot <- ggplot(planned_icu_only_imputed_mort30_marginal_effects_results, aes(model, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("Mort30 marginal effects results (Planned CCU only)")

# 60 day mortality 
## Odds ratios
load('planned_icu_only_imputed_mort60_pars_model_log_odds_est.rda')
age_cat_y3 <- planned_icu_only_imputed_mort60_pars_model_log_odds_est %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high))
age_cat_y3 <-   age_cat_y3 %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) %>% 
         mutate(model = factor(model) %>%
  fct_relevel("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model"))


planned_icu_only_imputed_mort60_all_results_plot <- ggplot(age_cat_y3, aes(model, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("60 day mortality all results (Planned CCU only)")

### Average Treatment effects (aka marginal effects)
 
a <- planned_icu_only_imputed_marginal_effects_table_pars_log_reg[3,]

planned_icu_only_imputed_mort60_marginal_effects_results <- a %>%  
  dplyr::select("model", everything()) %>% 
  mutate(model = factor(model) %>% 
  fct_relevel("mort60")) %>% 
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))

planned_icu_only_imputed_mort60_marginal_effects_results_plot <- ggplot(planned_icu_only_imputed_mort60_marginal_effects_results , aes(model, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  ylab("Average Treatment Effect") +
  coord_flip() + 
  theme_classic() +
  ggtitle("Mort60 marginal effects results (Planned CCU only)")

```

# Sensitivity Analysis 4: Analyses stratified by SORT score

## Create subgroups based on all patients above a SORT threshold (e.g. all patients with SORT over 1%, then all patients with SORT over 2%, etc)
```{r, eval=FALSE}
## Create new datasets based on threshold % groups
patients_labelled6_imputed_sort1_over <- patients_labelled6_imputed_dta %>% filter(SORT_mort_perc >= 1)
patients_labelled6_imputed_sort2_over <- patients_labelled6_imputed_dta %>% filter(SORT_mort_perc >= 2)
patients_labelled6_imputed_sort3_over <- patients_labelled6_imputed_dta %>% filter(SORT_mort_perc >= 3)
patients_labelled6_imputed_sort4_over <- patients_labelled6_imputed_dta %>% filter(SORT_mort_perc >= 4)
patients_labelled6_imputed_sort5_over <- patients_labelled6_imputed_dta %>% filter(SORT_mort_perc >= 5)

# write dta files for use in Stata
write.dta(patients_labelled6_imputed_sort1_over, "patients_labelled6_imputed_sort1_over.dta")
write.dta(patients_labelled6_imputed_sort2_over, "patients_labelled6_imputed_sort2_over.dta")
write.dta(patients_labelled6_imputed_sort3_over, "patients_labelled6_imputed_sort3_over.dta")
write.dta(patients_labelled6_imputed_sort4_over, "patients_labelled6_imputed_sort4_over.dta")
write.dta(patients_labelled6_imputed_sort5_over, "patients_labelled6_imputed_sort5_over.dta")

```

## Logistic regression analyses
For the regression analyses, 4 regression models were run for each outcome: An unadjusted regression, A single-level adjusted logistic regression (i.e. without clustering on hospital site), A single-level adjusted logistic regression with cluster robust Std Errors (using hospital site as the cluster to adjust the Std Errors on), A multi-level (aka random effects) adjusted logistic regression with clustering by hospital site. This was done to compare the results between the different approaches. 
- For the purposes of publication, the multi-level logistic regression was chosen as the most appropriate model to report results for. 

### > 1%
Unadjusted
```{r, results=TRUE}

log_POMS_impute_SORT1over_clean <- glm(POMS.factor ~ icu_adm.factor,
                data = patients_labelled6_imputed_sort1_over,
                family = "binomial")

log_odds_table_log_POMS_impute_SORT1over_clean <- log_POMS_impute_SORT1over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_POMS_impute_SORT1over_clean, file='log_odds_table_log_POMS_impute_SORT1over_clean.rda')
odds_ratio_table_log_POMS_impute_SORT1over_clean <- log_POMS_impute_SORT1over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_POMS_impute_SORT1over_clean, file='odds_ratio_table_log_POMS_impute_SORT1over_clean.rda')
av_marg_eff_log_POMS_impute_SORT1over_clean <- margins(log_POMS_impute_SORT1over_clean, variables = c("icu_adm.factor")) %>% summary()

```

Single-level logistic regression (without cluster SEs)
```{r}
log_poms_age_cat_impute_norm_pars_SORT1over_clean <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = patients_labelled6_imputed_sort1_over,
                family = "binomial")

summary(log_poms_age_cat_impute_norm_pars_SORT1over_clean)
log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean <- log_poms_age_cat_impute_norm_pars_SORT1over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean, file='log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean <- log_poms_age_cat_impute_norm_pars_SORT1over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean.rda')
av_marg_eff_log_poms_age_cat_impute_norm_pars_SORT1over_clean <- margins(log_poms_age_cat_impute_norm_pars_SORT1over_clean, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster <- coeftest(log_poms_age_cat_impute_norm_pars_SORT1over_clean, vcov = vcovCL, cluster = ~ SiteCode)
log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster 
log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster <- log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster, file='log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster.rda')
```

Random intercept model
```{r}

 log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect <- patients_labelled6_imputed_sort1_over %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect)
log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect, file='log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect.rda')
```

Combine results into tables
```{r}
a <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean[2,]
b <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_cluster[2,]
c <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_log_POMS_impute_SORT1over_clean[2,]

poms_age_cat_impute_norm_pars_model_log_odds_est_SORT1over_clean <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(poms_age_cat_impute_norm_pars_model_log_odds_est_SORT1over_clean, file='poms_age_cat_impute_norm_pars_model_log_odds_est_SORT1over_clean.rda')

# Collect the marginal effects into a table

POMS_marginal_effects_table_impute_norm_pars_log_reg_age_cat_SORT1over_clean <- rbind(av_marg_eff_log_poms_age_cat_impute_norm_pars_SORT1over_clean) %>% 
  mutate(model = c('POMS')) 
save(POMS_marginal_effects_table_impute_norm_pars_log_reg_age_cat_SORT1over_clean, file='POMS_marginal_effects_table_impute_norm_pars_log_reg_age_cat_SORT1over_clean.rda')
```


### >2 
Unadjusted
```{r, results=TRUE}

log_POMS_impute_SORT2over_clean <- glm(POMS.factor ~ icu_adm.factor,
                data = patients_labelled6_imputed_sort2_over,
                family = "binomial")

log_odds_table_log_POMS_impute_SORT2over_clean <- log_POMS_impute_SORT2over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_POMS_impute_SORT2over_clean, file='log_odds_table_log_POMS_impute_SORT2over_clean.rda')
odds_ratio_table_log_POMS_impute_SORT2over_clean <- log_POMS_impute_SORT2over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_POMS_impute_SORT2over_clean, file='odds_ratio_table_log_POMS_impute_SORT2over_clean.rda')
av_marg_eff_log_POMS_impute_SORT2over_clean <- margins(log_POMS_impute_SORT2over_clean, variables = c("icu_adm.factor")) %>% summary()

```

Single-level logistic regression (without cluster SEs)
```{r}
log_poms_age_cat_impute_norm_pars_SORT2over_clean <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = patients_labelled6_imputed_sort2_over,
                family = "binomial")

summary(log_poms_age_cat_impute_norm_pars_SORT2over_clean)
log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean <- log_poms_age_cat_impute_norm_pars_SORT2over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean, file='log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean <- log_poms_age_cat_impute_norm_pars_SORT2over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean.rda')
av_marg_eff_log_poms_age_cat_impute_norm_pars_SORT2over_clean <- margins(log_poms_age_cat_impute_norm_pars_SORT2over_clean, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster <- coeftest(log_poms_age_cat_impute_norm_pars_SORT2over_clean, vcov = vcovCL, cluster = ~ SiteCode)
log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster # as expected the SEs are larger
log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster <- log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster, file='log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster.rda')
```

Random intercept model
```{r}
 log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect <- patients_labelled6_imputed_sort2_over %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect)
log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect, file='log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect.rda')
```


Combine results into tables
```{r}
a <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean[2,]
b <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_cluster[2,]
c <- log_odds_table_log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_log_POMS_impute_SORT2over_clean[2,]


poms_age_cat_impute_norm_pars_model_log_odds_est_SORT2over_clean <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(poms_age_cat_impute_norm_pars_model_log_odds_est_SORT2over_clean, file='poms_age_cat_impute_norm_pars_model_log_odds_est_SORT2over_clean.rda')

# Collect the marginal effects into a table

marginal_effects_table_impute_norm_pars_log_reg_age_cat_SORT2over_clean <- rbind(av_marg_eff_log_poms_age_cat_impute_norm_pars_SORT2over_clean) %>% 
  mutate(model = c('POMS')) 
save(marginal_effects_table_impute_norm_pars_log_reg_age_cat_SORT2over_clean, file='marginal_effects_table_impute_norm_pars_log_reg_age_cat_SORT2over_clean.rda')
```


### >3 
Unadjusted
```{r, results=TRUE}

log_POMS_impute_sort3over_clean <- glm(POMS.factor ~ icu_adm.factor,
                data = patients_labelled6_imputed_sort3_over,
                family = "binomial")

log_odds_table_log_POMS_impute_sort3over_clean <- log_POMS_impute_sort3over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_POMS_impute_sort3over_clean, file='log_odds_table_log_POMS_impute_sort3over_clean.rda')
odds_ratio_table_log_POMS_impute_sort3over_clean <- log_POMS_impute_sort3over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_POMS_impute_sort3over_clean, file='odds_ratio_table_log_POMS_impute_sort3over_clean.rda')
av_marg_eff_log_POMS_impute_sort3over_clean <- margins(log_POMS_impute_sort3over_clean, variables = c("icu_adm.factor")) %>% summary()

```

Single-level logistic regression (without cluster SEs)
```{r}
log_poms_age_cat_impute_norm_pars_sort3over_clean <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = patients_labelled6_imputed_sort3_over,
                family = "binomial")

summary(log_poms_age_cat_impute_norm_pars_sort3over_clean)
log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean <- log_poms_age_cat_impute_norm_pars_sort3over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean <- log_poms_age_cat_impute_norm_pars_sort3over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean.rda')
av_marg_eff_log_poms_age_cat_impute_norm_pars_sort3over_clean <- margins(log_poms_age_cat_impute_norm_pars_sort3over_clean, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster <- coeftest(log_poms_age_cat_impute_norm_pars_sort3over_clean, vcov = vcovCL, cluster = ~ SiteCode)
log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster # as expected the SEs are larger
log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster <- log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster.rda')
```

Random intercept model
```{r}
 log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect <- patients_labelled6_imputed_sort3_over %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect)
log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect.rda')
```

Combine results into tables
```{r}
a <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean[2,]
b <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_cluster[2,]
c <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_log_POMS_impute_sort3over_clean[2,]


poms_age_cat_impute_norm_pars_model_log_odds_est_sort3over_clean <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(poms_age_cat_impute_norm_pars_model_log_odds_est_sort3over_clean, file='poms_age_cat_impute_norm_pars_model_log_odds_est_sort3over_clean.rda')

# Collect the marginal effects into a table

marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort3over_clean <- rbind(av_marg_eff_log_poms_age_cat_impute_norm_pars_sort3over_clean) %>% 
  mutate(model = c('POMS')) 
save(marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort3over_clean, file='marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort3over_clean.rda')
```

### >4 
Unadjusted
```{r, results=TRUE}

log_POMS_impute_sort4over_clean <- glm(POMS.factor ~ icu_adm.factor,
                data = patients_labelled6_imputed_sort4_over,
                family = "binomial")

log_odds_table_log_POMS_impute_sort4over_clean <- log_POMS_impute_sort4over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_POMS_impute_sort4over_clean, file='log_odds_table_log_POMS_impute_sort4over_clean.rda')
odds_ratio_table_log_POMS_impute_sort4over_clean <- log_POMS_impute_sort4over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_POMS_impute_sort4over_clean, file='odds_ratio_table_log_POMS_impute_sort4over_clean.rda')
av_marg_eff_log_POMS_impute_sort4over_clean <- margins(log_POMS_impute_sort4over_clean, variables = c("icu_adm.factor")) %>% summary()

```

Single-level logistic regression (without cluster SEs)
```{r}
log_poms_age_cat_impute_norm_pars_sort4over_clean <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = patients_labelled6_imputed_sort4_over,
                family = "binomial")

summary(log_poms_age_cat_impute_norm_pars_sort4over_clean)
log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean <- log_poms_age_cat_impute_norm_pars_sort4over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean <- log_poms_age_cat_impute_norm_pars_sort4over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean.rda')
av_marg_eff_log_poms_age_cat_impute_norm_pars_sort4over_clean <- margins(log_poms_age_cat_impute_norm_pars_sort4over_clean, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster <- coeftest(log_poms_age_cat_impute_norm_pars_sort4over_clean, vcov = vcovCL, cluster = ~ SiteCode)
log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster 
log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster <- log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster.rda')
```

Random intercept model
```{r}

 log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect <- patients_labelled6_imputed_sort4_over %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect)
log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect.rda')
```

Combine results into tables
```{r}
a <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean[2,]
b <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_cluster[2,]
c <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_log_POMS_impute_sort4over_clean[2,]


poms_age_cat_impute_norm_pars_model_log_odds_est_sort4over_clean <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(poms_age_cat_impute_norm_pars_model_log_odds_est_sort4over_clean, file='poms_age_cat_impute_norm_pars_model_log_odds_est_sort4over_clean.rda')

# Collect the marginal effects into a table

marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort4over_clean <- rbind(av_marg_eff_log_poms_age_cat_impute_norm_pars_sort4over_clean) %>% 
  mutate(model = c('POMS')) 
save(marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort4over_clean, file='marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort4over_clean.rda')
```

### >5 
Unadjusted
```{r, results=TRUE}

log_POMS_impute_sort5over_clean <- glm(POMS.factor ~ icu_adm.factor,
                data = patients_labelled6_imputed_sort5_over,
                family = "binomial")

log_odds_table_log_POMS_impute_sort5over_clean <- log_POMS_impute_sort5over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_POMS_impute_sort5over_clean, file='log_odds_table_log_POMS_impute_sort5over_clean.rda')
odds_ratio_table_log_POMS_impute_sort5over_clean <- log_POMS_impute_sort5over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_POMS_impute_sort5over_clean, file='odds_ratio_table_log_POMS_impute_sort5over_clean.rda')
av_marg_eff_log_POMS_impute_sort5over_clean <- margins(log_POMS_impute_sort5over_clean, variables = c("icu_adm.factor")) %>% summary()

```

Single-level logistic regression (without cluster SEs)
```{r}
log_poms_age_cat_impute_norm_pars_sort5over_clean <- glm(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                data = patients_labelled6_imputed_sort5_over,
                family = "binomial")

summary(log_poms_age_cat_impute_norm_pars_sort5over_clean)
log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean <- log_poms_age_cat_impute_norm_pars_sort5over_clean %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean <- log_poms_age_cat_impute_norm_pars_sort5over_clean %>% tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean.rda')
av_marg_eff_log_poms_age_cat_impute_norm_pars_sort5over_clean <- margins(log_poms_age_cat_impute_norm_pars_sort5over_clean, variables = c("icu_adm.factor")) %>% summary()
```

Single-level logistic regression with cluster robust SEs
```{r}
log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster <- coeftest(log_poms_age_cat_impute_norm_pars_sort5over_clean, vcov = vcovCL, cluster = ~ SiteCode)
log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster 
log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster <- log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster.rda')
```

Random intercept model
```{r}

 log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect <- patients_labelled6_imputed_sort5_over %>% 
  glmer(POMS.factor ~ icu_adm.factor  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect)
log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect, file='log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect.rda')
odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect <- log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect, file='odds_ratio_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect.rda')
```

Combine results into tables
```{r}
a <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean[2,]
b <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_cluster[2,]
c <- log_odds_table_log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect[2, c(3,4,5,6,7,8,9)]
d <- log_odds_table_log_POMS_impute_sort5over_clean[2,]


poms_age_cat_impute_norm_pars_model_log_odds_est_sort5over_clean <- rbind(a,b,c,d) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Unadjusted logistic regression")) %>% 
  dplyr::select("model", everything())

save(poms_age_cat_impute_norm_pars_model_log_odds_est_sort5over_clean, file='poms_age_cat_impute_norm_pars_model_log_odds_est_sort5over_clean.rda')

# Collect the marginal effects into a table

marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort5over_clean <- rbind(av_marg_eff_log_poms_age_cat_impute_norm_pars_sort5over_clean) %>% 
  mutate(model = c('POMS')) 
save(marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort5over_clean, file='marginal_effects_table_impute_norm_pars_log_reg_age_cat_sort5over_clean.rda')
```

## IV analyses
Load in results of IV analysis from Stata. These are obtained from running the Stata scripts for the analyses at each threshold of SORT mortality estimate. The names of these scripts are: 
"SNAP2_IV_Main_Analyses_Stata" (NB - Threshold > 0 is an identical population to the main SNAP IV analysis)
"SNAP2_IV_SORT_Threshold_over_1_Stata"
"SNAP2_IV_SORT_Threshold_over_2_Stata"
"SNAP2_IV_SORT_Threshold_over_3_Stata"
"SNAP2_IV_SORT_Threshold_over_4_Stata"
"SNAP2_IV_SORT_Threshold_over_5_Stata"
```{r}
CCU_IV_POMS_pars_mv_impute_norm <- read_excel("CCU_IV_POMS_pars_mv_impute_norm_age_cat.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 

CCU_IV_int_sort_1over_pars_mv <- read_excel("CCU_IV_sort_1+_pars_mv.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 
CCU_IV_int_sort_2over_pars_mv <- read_excel("CCU_IV_sort_2+_pars_mv.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`))
CCU_IV_int_sort_3over_pars_mv <- read_excel("CCU_IV_sort_3+_pars_mv.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`))
CCU_IV_int_sort_4over_pars_mv <- read_excel("CCU_IV_sort_4+_pars_mv.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`))
CCU_IV_int_sort_5over_pars_mv <- read_excel("CCU_IV_sort_5+_pars_mv.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`))


## Combine into table
a <- CCU_IV_POMS_pars_mv_impute_norm[c(2),]
b <- CCU_IV_int_sort_1over_pars_mv[c(2),]
c <- CCU_IV_int_sort_2over_pars_mv[c(2),]
d <- CCU_IV_int_sort_3over_pars_mv[c(2),]
e <- CCU_IV_int_sort_4over_pars_mv[c(2),]
f <- CCU_IV_int_sort_5over_pars_mv[c(2),]

SORT_levels_bivariate_probit_results <- rbind(a,b,c,d,e,f) %>% 
  mutate(outcome = c("Overall", "1+", "2+", "3+", "4+", "5+")) %>% 
  dplyr::select("outcome", everything()) %>% 
  mutate(outcome = factor(outcome) %>% 
  fct_relevel("Overall", "1+", "2+", "3+", "4+", "5+"))

save(SORT_levels_bivariate_probit_results, file='SORT_levels_bivariate_probit_results.rda')

# Odds Ratio plot
SORT_levels_bivariate_probit_results_plot <- ggplot(SORT_levels_bivariate_probit_results, aes(outcome, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("SORT Threshold") +
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))

## Average Treatment effects (aka marginal effects)
### Note: ATE results are obtained when running the Stata scripts above. Results are manually copied across from Stata.

# Create dataframe to put results into
SORT_levels_bivariate_probit_marginal_results <- data.frame(
                    variable = character(), 
                    AME = numeric(),
                    SE = numeric(),
                    z = numeric(),
                    p = numeric(),
                    lower = numeric(),
                    upper = numeric(),
                    SORT = character(),
                    stringsAsFactors = FALSE)

# Add ATE results into dataframe
SORT_levels_bivariate_probit_marginal_results[1,] <-  c("icu_adm.factorTRUE", -0.012, 0.025, -0.48, 0.631, -0.061, 0.037, "Overall")
SORT_levels_bivariate_probit_marginal_results[2,] <-  c("icu_adm.factorTRUE", 0.071, 0.076, 0.94, 0.348, -0.077, 0.22, "1+")
SORT_levels_bivariate_probit_marginal_results[3,] <-  c("icu_adm.factorTRUE", 0.029, 0.101, 0.29, 0.772, -0.169, 0.227, "2+")
SORT_levels_bivariate_probit_marginal_results[4,] <-  c("icu_adm.factorTRUE", -0.016, 0.11, -0.15, 0.883, -0.23, 0.20, "3+")
SORT_levels_bivariate_probit_marginal_results[5,] <-  c("icu_adm.factorTRUE", -0.109, 0.14, -0.78, 0.436, -0.383, 0.165, "4+")
SORT_levels_bivariate_probit_marginal_results[6,] <-  c("icu_adm.factorTRUE", -0.178, 0.127, -1.40, 0.160, -0.428, 0.071, "5+")

# Recode variables in dataframe
SORT_levels_bivariate_probit_marginal_results <- SORT_levels_bivariate_probit_marginal_results %>% 
  mutate(SORT = factor(SORT) %>% 
  fct_relevel("Overall", "1+", "2+", "3+", "4+", "5+")) %>% 
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))
  
save(SORT_levels_bivariate_probit_marginal_results, file = 'SORT_levels_bivariate_probit_marginal_results.rda')  

# Plot ATE results
SORT_levels_bivariate_probit_marginal_results_plot <- ggplot(SORT_levels_bivariate_probit_marginal_results, aes(SORT, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("SORT Threshold") +
  ylab("Average Treatment Effect") +
  theme_classic() +
  ggtitle("") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))

# Combine OR and ATE plots
combine_plot_SORT_thresholds <- SORT_levels_bivariate_probit_results_plot / SORT_levels_bivariate_probit_marginal_results_plot
combine_plot_SORT_thresholds <- combine_plot_SORT_thresholds + plot_annotation(tag_levels = 'a')
```

## Plot logistic regression analyses with the IV analyses
```{r}
# POMS
load('poms_impute_norm_log_odds_est.rda')
load('poms_age_cat_impute_norm_pars_model_log_odds_est_SORT1over_clean.rda')
load('poms_age_cat_impute_norm_pars_model_log_odds_est_SORT2over_clean.rda')
load('poms_age_cat_impute_norm_pars_model_log_odds_est_sort3over_clean.rda')
load('poms_age_cat_impute_norm_pars_model_log_odds_est_sort4over_clean.rda')
load('poms_age_cat_impute_norm_pars_model_log_odds_est_sort5over_clean.rda')
load('SORT_levels_bivariate_probit_results.rda')

iv_threshold_results <- SORT_levels_bivariate_probit_results %>% 
  dplyr::select(c(outcome, or_est, or_min95, or_max95)) %>% 
  mutate(Analysis = c("IV (SORT : Overall)", "IV (SORT : 1+)", "IV (SORT : 2+)", "IV (SORT : 3+)", "IV (SORT : 4+)", "IV (SORT : 5+)")) %>% 
  mutate(model = "Bivariate Probit")

aa <- poms_impute_norm_log_odds_est %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>% 
  mutate(Analysis = "Logistic regression (SORT : Overall)") %>% 
  mutate(outcome = "Overall") %>% 
  dplyr::select(c(outcome, or_est, or_min95, or_max95, Analysis, model))

a <- poms_age_cat_impute_norm_pars_model_log_odds_est_SORT1over_clean %>% 
  mutate(Analysis = "Logistic regression (SORT : 1+)") %>% 
  mutate(outcome = "1+") %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>%
  dplyr::select(c(outcome, or_est, or_min95, or_max95, Analysis, model))

b <- poms_age_cat_impute_norm_pars_model_log_odds_est_SORT2over_clean %>% 
  mutate(Analysis = "Logistic regression (SORT : 2+)") %>% 
  mutate(outcome = "2+") %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>%
  dplyr::select(c(outcome, or_est, or_min95, or_max95, Analysis, model))

c <- poms_age_cat_impute_norm_pars_model_log_odds_est_sort3over_clean %>% 
  mutate(Analysis = "Logistic regression (SORT : 3+)") %>% 
  mutate(outcome = "3+") %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>%
  dplyr::select(c(outcome, or_est, or_min95, or_max95, Analysis, model))

d <- poms_age_cat_impute_norm_pars_model_log_odds_est_sort4over_clean %>% 
  mutate(Analysis = "Logistic regression (SORT : 4+)") %>% 
  mutate(outcome = "4+") %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>%
  dplyr::select(c(outcome, or_est, or_min95, or_max95, Analysis, model))

e <- poms_age_cat_impute_norm_pars_model_log_odds_est_sort5over_clean %>% 
  mutate(Analysis = "Logistic regression (SORT : 5+)") %>% 
  mutate(outcome = "5+") %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>%
  dplyr::select(c(outcome, or_est, or_min95, or_max95, Analysis, model))

mv_iv_thresholds_combined_results <- rbind(iv_threshold_results, aa, a, b, c, d, e) %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) %>% 
         mutate(model = factor(model) %>%
  fct_relevel("Unadjusted logistic regression","Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Bivariate Probit"))

# Tidy up table above before plotting
mv_iv_thresholds_combined_results_pub <- mv_iv_thresholds_combined_results %>% 
  filter(model == "Bivariate Probit" | model == "Random intercept model") %>% 
  mutate(Model = fct_recode(model, 
                          "Multilevel multivariable regression" = "Random intercept model",
                          "Instrumental variable analysis" = "Bivariate Probit")) %>%
  mutate(Analysis = factor(Analysis) %>% 
           fct_relevel("IV (SORT : Overall)", "Logistic regression (SORT : Overall)", "IV (SORT : 1+)", "Logistic regression (SORT : 1+)", "IV (SORT : 2+)", "Logistic regression (SORT : 2+)", "IV (SORT : 3+)", "Logistic regression (SORT : 3+)", "IV (SORT : 4+)", "Logistic regression (SORT : 4+)", "IV (SORT : 5+)", "Logistic regression (SORT : 5+)"))

# OR plot
mv_iv_thresholds_combined_results_pub_plot <- ggplot(mv_iv_thresholds_combined_results_pub, aes(Analysis, or_est)) +  
  geom_point(aes(colour = Model), pch = 19) +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95, colour = Model)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("Analysis (SORT Threshold)") +
  ylab("Odds Ratio (log scale)") +
  theme_classic() + 
  theme(legend.position="none") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20))) +
  scale_color_manual(values = c("Instrumental variable analysis" = "black",
                                "Multilevel multivariable regression"="#1770b8")) 


```


# Sensitivity Analysis 5: Use of different definitions of CCU bed availability 

For each definition of CCU bed availability, we first display the first stage regression of bed availability of Bed Availability vs Probability of CCU admission, and then display the results of the IV analysis. These results are compared to the results for the definition of bed availability used in the main analyses (i.e. Empty + Discharge Ready beds)

For the regression analyses, 3 regression models were run for each outcome: A single-level adjusted logistic regression (i.e. without clustering on hospital site), A single-level adjusted logistic regression with cluster robust Std Errors (using hospital site as the cluster to adjust the Std Errors on), A multi-level (aka random effects) adjusted logistic regression with clustering by hospital site. This was done to compare the results between the different approaches. 
- For the purposes of publication, the multi-level logistic regression was chosen as the most appropriate model to report results for. 

## Bed availability definfition:  0 Empty Beds vs 1 Empty Beds vs 2+ Empty Beds (Categorical)

### Bed availability vs Probability of CCU admission 
```{r}
## MV analysis
log_icu_impute_norm <- glm(icu_adm.factor ~ EmptyBedsTimeofSurgCat + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                                             data = patients_labelled6_imputed,
                                             family = "binomial")

summary(log_icu_impute_norm)
log_odds_table_log_icu_impute_norm <- log_icu_impute_norm %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_icu_impute_norm, file='log_odds_table_log_icu_impute_norm.rda')
odds_ratio_table_log_icu_impute_norm <- log_icu_impute_norm %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_icu_impute_norm, file='odds_ratio_table_log_icu_impute_norm.rda')

## MV analysis - cluster SE
log_icu_impute_norm_cluster <- coeftest(log_icu_impute_norm, vcov = vcovCL, cluster = ~ SiteCode)
log_icu_impute_norm_cluster
log_odds_table_log_icu_impute_norm_cluster <- log_icu_impute_norm_cluster %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_icu_impute_norm_cluster, file='log_odds_table_log_icu_impute_norm_cluster.rda')
odds_ratio_table_log_icu_impute_norm_cluster <-  log_odds_table_log_icu_impute_norm_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value) 
save(odds_ratio_table_log_icu_impute_norm_cluster, file='odds_ratio_table_log_icu_impute_norm_cluster.rda')


## Random effects models
 log_icu_impute_norm_random_effect <- patients_labelled6_imputed %>% 
  glmer(icu_adm.factor ~ EmptyBedsTimeofSurgCat  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_icu_impute_norm_random_effect)
log_odds_table_log_icu_impute_norm_random_effect <- log_icu_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_icu_impute_norm_random_effect, file='log_odds_table_log_icu_impute_norm_random_effect.rda')
odds_ratio_table_log_icu_impute_norm_random_effect <- log_icu_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_icu_impute_norm_random_effect, file='odds_ratio_table_log_icu_impute_norm_random_effect.rda')



# Save results into display tables
a <- log_odds_table_log_icu_impute_norm[c(2,3),]
b <- log_odds_table_log_icu_impute_norm_cluster[c(2,3),]
c <- log_odds_table_log_icu_impute_norm_random_effect[c(2,3), c(3,4,5,6,7,8,9)]


icu_impute_norm_log_odds_est <- rbind(a,b,c) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Single-level logistic regression with cluster robust SEs", "Random intercept model", "Random intercept model")) %>% 
  dplyr::select("model", everything())

save(icu_impute_norm_log_odds_est, file='icu_impute_norm_log_odds_est.rda')

```

### Load in results of IV analysis 
Load in results of IV analysis from Stata (run the Stata script "SNAP2_IV_Empty_Beds_Cat_Stata" to obtain the results which are loaded in here)
```{r}
tb_IV_POMS_pars_mv_impute_norm_age_cat <- read_excel("tb_IV_POMS_pars_mv_impute_norm_age_cat.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 
```


## Bed availability definfition: Empty Beds on continuous scale

### Bed availability vs Probability of CCU admission 
```{r}
## MV analysis
log_icu_continuous_impute_norm <- glm(icu_adm.factor ~ EmptyBedsTimeofSurgery + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                                             data = patients_labelled6_imputed,
                                             family = "binomial")

summary(log_icu_continuous_impute_norm)
log_odds_table_log_icu_continuous_impute_norm <- log_icu_continuous_impute_norm %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_icu_continuous_impute_norm, file='log_odds_table_log_icu_continuous_impute_norm.rda')
odds_ratio_table_log_icu_continuous_impute_norm <- log_icu_continuous_impute_norm %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_icu_continuous_impute_norm, file='odds_ratio_table_log_icu_continuous_impute_norm.rda')

## MV analysis - cluster SE
log_icu_continuous_impute_norm_cluster <- coeftest(log_icu_continuous_impute_norm, vcov = vcovCL, cluster = ~ SiteCode)
log_icu_continuous_impute_norm_cluster
log_odds_table_log_icu_continuous_impute_norm_cluster <- log_icu_continuous_impute_norm_cluster %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_icu_continuous_impute_norm_cluster, file='log_odds_table_log_icu_continuous_impute_norm_cluster.rda')
odds_ratio_table_log_icu_continuous_impute_norm_cluster <-  log_odds_table_log_icu_continuous_impute_norm_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value) 
save(odds_ratio_table_log_icu_continuous_impute_norm_cluster, file='odds_ratio_table_log_icu_continuous_impute_norm_cluster.rda')


## Random effects models
 log_icu_continuous_impute_norm_random_effect <- patients_labelled6_imputed %>% 
  glmer(icu_adm.factor ~ EmptyBedsTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_icu_continuous_impute_norm_random_effect)
log_odds_table_log_icu_continuous_impute_norm_random_effect <- log_icu_continuous_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_icu_continuous_impute_norm_random_effect, file='log_odds_table_log_icu_continuous_impute_norm_random_effect.rda')
odds_ratio_table_log_icu_continuous_impute_norm_random_effect <- log_icu_continuous_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE)
save(odds_ratio_table_log_icu_continuous_impute_norm_random_effect, file='odds_ratio_table_log_icu_continuous_impute_norm_random_effect.rda')



# Save results into display tables
a <- log_odds_table_log_icu_continuous_impute_norm[c(2),]
b <- log_odds_table_log_icu_continuous_impute_norm_cluster[c(2),]
c <- log_odds_table_log_icu_continuous_impute_norm_random_effect[c(2), c(3,4,5,6,7,8,9)]


icu_continuous_impute_norm_log_odds_est <- rbind(a,b,c) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)", "Single-level logistic regression with cluster robust SEs", "Random intercept model")) %>% 
  dplyr::select("model", everything())

save(icu_continuous_impute_norm_log_odds_est, file='icu_continuous_impute_norm_log_odds_est.rda')

```

### Load in results of IV analysis 
Load in results of IV analysis from Stata (run the Stata script "SNAP2_IV_Empty_Beds_Cont_Stata" to obtain the results which are loaded in here)
```{r}
Empty_continuous_IV_POMS_pars_mv_impute_norm_age_cat <- read_excel("Empty_continuous_IV_POMS_pars_mv_impute_norm_age_cat.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 
```

## Bed availability definfition: Proportion of total CCU capacity that are empty beds at time of surgery

### Bed availability vs Probability of CCU admission 
```{r}

## MV analysis
log_prop_empty_impute_norm <- glm(icu_adm.factor ~ PropEmptyTimeofSurgery + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                                             data = patients_labelled6_imputed,
                                             family = "binomial")

summary(log_prop_empty_impute_norm)
log_odds_table_log_prop_empty_impute_norm <- log_prop_empty_impute_norm %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_prop_empty_impute_norm, file='log_odds_table_log_prop_empty_impute_norm.rda')
odds_ratio_table_log_prop_empty_impute_norm <- log_prop_empty_impute_norm %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_prop_empty_impute_norm, file='odds_ratio_table_log_prop_empty_impute_norm.rda')

## MV analysis - cluster SE
log_prop_empty_impute_norm_cluster <- coeftest(log_prop_empty_impute_norm, vcov = vcovCL, cluster = ~ SiteCode)
log_prop_empty_impute_norm_cluster
log_odds_table_log_prop_empty_impute_norm_cluster <- log_prop_empty_impute_norm_cluster %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_prop_empty_impute_norm_cluster, file='log_odds_table_log_prop_empty_impute_norm_cluster.rda')
odds_ratio_table_log_prop_empty_impute_norm_cluster <-  log_odds_table_log_prop_empty_impute_norm_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value) 
save(odds_ratio_table_log_prop_empty_impute_norm_cluster, file='odds_ratio_table_log_prop_empty_impute_norm_cluster.rda')


## Random effects models
 log_prop_empty_impute_norm_random_effect <- patients_labelled6_imputed %>% 
  glmer(icu_adm.factor ~ PropEmptyTimeofSurgery  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_prop_empty_impute_norm_random_effect)
log_odds_table_log_prop_empty_impute_norm_random_effect <- log_prop_empty_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_prop_empty_impute_norm_random_effect, file='log_odds_table_log_prop_empty_impute_norm_random_effect.rda')
odds_ratio_table_log_prop_empty_impute_norm_random_effect <- log_prop_empty_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_prop_empty_impute_norm_random_effect, file='odds_ratio_table_log_prop_empty_impute_norm_random_effect.rda')



# Save results into display tables
a <- log_odds_table_log_prop_empty_impute_norm[c(2),]
b <- log_odds_table_log_prop_empty_impute_norm_cluster[c(2),]
c <- log_odds_table_log_prop_empty_impute_norm_random_effect[c(2), c(3,4,5,6,7,8,9)]


prop_empty_impute_norm_log_odds_est <- rbind(a,b,c) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)",  "Single-level logistic regression with cluster robust SEs",  "Random intercept model")) %>% 
  dplyr::select("model", everything())

save(prop_empty_impute_norm_log_odds_est, file='prop_empty_impute_norm_log_odds_est.rda')
```

### Load in results of IV analysis 
Load in results of IV analysis from Stata (run the Stata script "SNAP2_IV_Empty_Beds_Prop_Stata" to obtain the results which are loaded in here)
NB - we don't actually use Proportion of Empty Beds in the end as it is not a valid instrument as it is not significantly related to probability of CCU admission. It is included here just for completeness. 

```{r}
PropEmpty_IV_POMS_pars_mv_impute_norm_age_cat <- read_excel("PropEmpty_IV_POMS_pars_mv_impute_norm_age_cat.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 
```


## Bed availability definfition: 0 Empty Beds vs 2+ beds Empty Beds (Categorical but missing 1 Empty bed category). 
Done to maintain the significant difference in probability of admission between 0 vs 2+ beds, while reducing the number of instruments (i.e. 2 categories vs 3 categories)

Create dataset excluding patients with only 1 bed available at time of surgery
```{r}
empty_beds_0_vs_2_data <- patients_labelled6_imputed_dta %>% 
  filter(!(EmptyBedsTimeofSurgCat == 1)) %>% 
  droplevels(patients_labelled6_imputed_dta$EmptyBedsTimeofSurgCat)

write.dta(empty_beds_0_vs_2_data, "empty_beds_0_vs_2_data.dta")
```

### Bed availability vs Probability of CCU admission 
```{r}
## MV analysis
log_empty_0_vs_2_impute_norm <- glm(icu_adm.factor ~ EmptyBedsTimeofSurgCat + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss,
                                             data = empty_beds_0_vs_2_data,
                                             family = "binomial")

summary(log_empty_0_vs_2_impute_norm)
log_odds_table_log_empty_0_vs_2_impute_norm <- log_empty_0_vs_2_impute_norm %>% tidy(conf.int = TRUE, exp = FALSE)
save(log_odds_table_log_empty_0_vs_2_impute_norm, file='log_odds_table_log_empty_0_vs_2_impute_norm.rda')
odds_ratio_table_log_empty_0_vs_2_impute_norm <- log_empty_0_vs_2_impute_norm %>% tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_empty_0_vs_2_impute_norm, file='odds_ratio_table_log_empty_0_vs_2_impute_norm.rda')

## MV analysis - cluster SE
log_empty_0_vs_2_impute_norm_cluster <- coeftest(log_empty_0_vs_2_impute_norm, vcov = vcovCL, cluster = ~ SiteCode)
log_empty_0_vs_2_impute_norm_cluster
log_odds_table_log_empty_0_vs_2_impute_norm_cluster <- log_empty_0_vs_2_impute_norm_cluster %>% tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_empty_0_vs_2_impute_norm_cluster, file='log_odds_table_log_empty_0_vs_2_impute_norm_cluster.rda')
odds_ratio_table_log_empty_0_vs_2_impute_norm_cluster <-  log_odds_table_log_empty_0_vs_2_impute_norm_cluster %>%
  mutate(OR_estimate = exp(estimate),
         OR_conf.low = exp(conf.low),
         OR_conf.high = exp(conf.high)) %>% 
  dplyr::select(term, OR_estimate, OR_conf.low, OR_conf.high, p.value) 
save(odds_ratio_table_log_empty_0_vs_2_impute_norm_cluster, file='odds_ratio_table_log_empty_0_vs_2_impute_norm_cluster.rda')


## Random effects models
 log_empty_0_vs_2_impute_norm_random_effect <- empty_beds_0_vs_2_data %>% 
  glmer(icu_adm.factor ~ EmptyBedsTimeofSurgCat  + S01Gender  + age_p10  + weekend.factor  +  S02OperativeUrgency  + S02PlannedProcSeverity  + asa  +  PreopLOS.factor  +  combined_DHx  + combined_PMHx  + diabetes.factor  +  sysBP_scaled  + HR_scaled  +  Anaesthetist_grade_combined.factor  + Surgeon_grade_combined.factor + abnormal_bloodtest_impute_normal.factor + S04BloodLoss + (1 | SiteCode), data =., family = "binomial", control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))) 

summary( log_empty_0_vs_2_impute_norm_random_effect)
log_odds_table_log_empty_0_vs_2_impute_norm_random_effect <- log_empty_0_vs_2_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = FALSE) 
save(log_odds_table_log_empty_0_vs_2_impute_norm_random_effect, file='log_odds_table_log_empty_0_vs_2_impute_norm_random_effect.rda')
odds_ratio_table_log_empty_0_vs_2_impute_norm_random_effect <- log_empty_0_vs_2_impute_norm_random_effect %>% broom.mixed::tidy(conf.int = TRUE, exp = TRUE) 
save(odds_ratio_table_log_empty_0_vs_2_impute_norm_random_effect, file='odds_ratio_table_log_empty_0_vs_2_impute_norm_random_effect.rda')



# Save results into display tables
a <- log_odds_table_log_empty_0_vs_2_impute_norm[c(2),]
b <- log_odds_table_log_empty_0_vs_2_impute_norm_cluster[c(2),]
c <- log_odds_table_log_empty_0_vs_2_impute_norm_random_effect[c(2), c(3,4,5,6,7,8,9)]


empty_0_vs_2_impute_norm_log_odds_est <- rbind(a,b,c) %>% 
  mutate(model = c("Single-level logistic regression (without cluster SE)",  "Single-level logistic regression with cluster robust SEs",  "Random intercept model")) %>% 
  dplyr::select("model", everything())

save(empty_0_vs_2_impute_norm_log_odds_est, file='empty_0_vs_2_impute_norm_log_odds_est.rda')
```

### Load in results of IV analysis
Load in results of IV analysis from Stata (run the Stata script "SNAP2_IV_Empty_Beds_0_vs_2over_Stata" to obtain the results which are loaded in here)
```{r}
empty_0_vs_2_IV_POMS_pars_mv_impute_norm_age_cat <- read_excel("empty_0_vs_2_IV_POMS_pars_mv_impute_norm_age_cat.xlsx") %>% dplyr::select("eq_label", "Parameter name", "parm_label", everything()) %>% subset(select = -c(`Parameter label`,`Equation name`, `eq_order`)) 
```

## Combine results into tables

Bed availability vs Probability of CCU admission 
```{r}
load(file = 'ccu_impute_norm_log_odds_est.rda')
load(file = 'icu_impute_norm_log_odds_est.rda')
load(file = 'icu_continuous_impute_norm_log_odds_est.rda')
load(file = 'prop_empty_impute_norm_log_odds_est.rda')
load(file = 'empty_0_vs_2_impute_norm_log_odds_est.rda')


ccu_impute_norm_log_odds_est <- ccu_impute_norm_log_odds_est %>% 
  mutate(variable = "Available CCU beds (Empty + Discharge ready)") 
ccu_impute_norm_log_odds_est$model <-  paste("CCU_cont", ccu_impute_norm_log_odds_est$model, sep="_")

icu_impute_norm_log_odds_est <- icu_impute_norm_log_odds_est %>% 
  mutate(variable = ifelse(term == "EmptyBedsTimeofSurgCat1", "Empty CCU Beds: Categories (0,1,2+ beds) [1 bed]", "Empty CCU Beds: Categories (0,1,2+ beds) [2+ beds]"))
icu_impute_norm_log_odds_est$model <-  paste("Empty_cat", icu_impute_norm_log_odds_est$model, sep="_")

icu_continuous_impute_norm_log_odds_est <- icu_continuous_impute_norm_log_odds_est %>% 
  mutate(variable = "Empty CCU Beds")
icu_continuous_impute_norm_log_odds_est$model <-  paste("Empty_cont", icu_continuous_impute_norm_log_odds_est$model, sep="_")

prop_empty_impute_norm_log_odds_est <- prop_empty_impute_norm_log_odds_est %>% 
  mutate(variable = "Proportion of CCU beds that are empty") 
prop_empty_impute_norm_log_odds_est$model <-  paste("Prop_Empty", prop_empty_impute_norm_log_odds_est$model, sep="_")

empty_0_vs_2_impute_norm_log_odds_est <- empty_0_vs_2_impute_norm_log_odds_est %>% 
  mutate(variable = "Empty CCU Beds: Categories (0 vs 2+ beds) [2+ beds]") 
empty_0_vs_2_impute_norm_log_odds_est$model <-  paste("empty_0_vs_2", empty_0_vs_2_impute_norm_log_odds_est$model, sep="_")

variety_instruments_regression_results <- rbind(ccu_impute_norm_log_odds_est, icu_impute_norm_log_odds_est, icu_continuous_impute_norm_log_odds_est, prop_empty_impute_norm_log_odds_est, empty_0_vs_2_impute_norm_log_odds_est) %>% 
  mutate(variable = factor(variable)) %>% 
  mutate(model = factor(model)) %>% 
  mutate(or_est = exp(estimate),
         or_min95 = exp(conf.low),
         or_max95 = exp(conf.high)) %>% 
  mutate(or_est = as.numeric(or_est),
         or_min95 = as.numeric(or_min95),
         or_max95 = as.numeric(or_max95)) 

# Recode variables in table to make it more interpretable
variety_instruments_regression_results <- variety_instruments_regression_results %>% 
  filter(model == "CCU_cont_Random intercept model" | model == "Empty_cat_Random intercept model" | model == "Empty_cont_Random intercept model" | model == "Prop_Empty_Random intercept model" | model == "empty_0_vs_2_Random intercept model") %>% 
  mutate(Definition = fct_recode(model, 
                          "Available CCU beds (Empty + Discharge ready)" = "CCU_cont_Random intercept model", 
                          "Empty CCU Beds: Categories (0,1,2+ beds)" = "Empty_cat_Random intercept model",
                          "Empty CCU Beds" = "Empty_cont_Random intercept model", 
                          "Proportion of CCU beds that are empty" = "Prop_Empty_Random intercept model",
                          "Empty CCU Beds: Categories (0 vs 2+ beds)" = "empty_0_vs_2_Random intercept model") %>% fct_relevel("Available CCU beds (Empty + Discharge ready)", "Empty CCU Beds", "Empty CCU Beds: Categories (0,1,2+ beds)", "Empty CCU Beds: Categories (0 vs 2+ beds)" , "Proportion of CCU beds that are empty"))

save(variety_instruments_regression_results, file = 'variety_instruments_regression_results.rda')

```

IV analyses
```{r}
# Odds Ratios
CCU_cont <- CCU_IV_POMS_pars_mv_impute_norm[c(2),]
Empty_cat <- tb_IV_POMS_pars_mv_impute_norm_age_cat[c(2),]
Empty_cont <- Empty_continuous_IV_POMS_pars_mv_impute_norm_age_cat[c(2),]
Prop_Empty <- PropEmpty_IV_POMS_pars_mv_impute_norm_age_cat[c(2),]
empty_0_vs_2 <- empty_0_vs_2_IV_POMS_pars_mv_impute_norm_age_cat[c(2),]

variety_instruments_IV_results <- rbind(CCU_cont,Empty_cat,Empty_cont, Prop_Empty, empty_0_vs_2) %>% 
  mutate(Definition = c("Available CCU beds (Empty + Discharge ready)", "Empty CCU Beds: Categories (0,1,2+ beds)", "Empty CCU Beds", "Proportion of CCU beds that are empty", "Empty CCU Beds: Categories (0 vs 2+ beds)")) %>% 
  dplyr::select("Definition", everything()) %>% 
  mutate(outcome = factor(Definition) %>% 
  fct_relevel("Available CCU beds (Empty + Discharge ready)", "Empty CCU Beds", "Empty CCU Beds: Categories (0 vs 2+ beds)", "Empty CCU Beds: Categories (0,1,2+ beds)", "Proportion of CCU beds that are empty"))

save(variety_instruments_IV_results, file='variety_instruments_IV_results.rda')

## Average Treatment effects (aka marginal effects)
### Note: ATE results are obtained when running the Stata scripts above. Results are manually copied across from Stata.

# Create dataframe to put results into
variety_instruments_IV_AME_results <- data.frame(
                    variable = character(), 
                    AME = numeric(),
                    SE = numeric(),
                    z = numeric(),
                    p = numeric(),
                    lower = numeric(),
                    upper = numeric(),
                    Definition = character(),
                    stringsAsFactors = FALSE)

# Add ATE results into dataframe
variety_instruments_IV_AME_results[1,] <-  c("icu_adm.factorTRUE", -0.012, 0.025, -0.48, 0.631, -0.061, 0.037, "Available CCU beds (Empty + Discharge ready)")
variety_instruments_IV_AME_results[2,] <-  c("icu_adm.factorTRUE", -0.024, 0.025, -0.98, 0.327, -0.073, 0.024, "Empty CCU Beds")
variety_instruments_IV_AME_results[3,] <-  c("icu_adm.factorTRUE", -0.037, 0.024, -1.56, 0.120, -0.083, 0.009, "Empty CCU Beds: Categories (0 vs 2+ beds)")
variety_instruments_IV_AME_results[4,] <-  c("icu_adm.factorTRUE", -0.033, 0.24, -1.39, 0.166, -0.079, 0.014, "Empty CCU Beds: Categories (0,1,2+ beds)")
variety_instruments_IV_AME_results[5,] <-  c("icu_adm.factorTRUE", -0.032, 0.025, -1.29, 0.198, -0.082, 0.017, "Proportion of CCU beds that are empty")

# Recode variables to make more interpretable
variety_instruments_IV_AME_results <- variety_instruments_IV_AME_results %>% 
  mutate(Definition = factor(Definition) %>% 
  fct_relevel("Available CCU beds (Empty + Discharge ready)" , "Empty CCU Beds", "Empty CCU Beds: Categories (0 vs 2+ beds)", "Empty CCU Beds: Categories (0,1,2+ beds)", "Proportion of CCU beds that are empty")) %>% 
  mutate(AME = as.numeric(AME),
         lower = as.numeric(lower),
         upper = as.numeric(upper))
  
save(variety_instruments_IV_AME_results, file = 'variety_instruments_IV_AME_results.rda')  

```

## Plot results

Bed availability vs Probability of CCU admission
```{r}
variety_instruments_regression_results_plot <-
  ggplot(variety_instruments_regression_results, aes(variable, or_est)) +  
  geom_point(aes(colour = Definition), pch = 19) +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95, colour = Definition)) +
  scale_y_continuous(trans='log10') + 
  expand_limits(y = 0.5) +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  xlab("Definition") +
  ylab("Odds Ratio (log scale)") + 
  theme_classic() +
  theme(plot.title=element_text(size=10)) +
    scale_color_manual(values = c("Available CCU beds (Empty + Discharge ready)" = "black",
                                "Empty CCU Beds"="#0c385c",
                                "Empty CCU Beds: Categories (0 vs 2+ beds)"="#1770b8",
                                "Empty CCU Beds: Categories (0,1,2+ beds)"="#d0d9f0",
                                "Proportion of CCU beds that are empty"="#6b8ac5")) +
  ggtitle("") +
  theme(legend.position="none")  +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))
```

IV analyses
```{r}
variety_instruments_IV_results_plot <- ggplot(variety_instruments_IV_results, aes(Definition, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20)))



# Without Proportion of Empty beds as not a valid instrument
variety_instruments_IV_results_minus_PropEmpty <- variety_instruments_IV_results %>% 
  filter(!(Definition == "Proportion of CCU beds that are empty"))

variety_instruments_IV_results_plot_minus_PropEmpty_plot <- ggplot(variety_instruments_IV_results_minus_PropEmpty, aes(Definition, or_est)) +  
  geom_point() +
  geom_errorbar(aes(ymin = or_min95, ymax = or_max95)) +
  scale_y_continuous(trans='log10') +
  geom_hline(yintercept = 1, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Odds Ratio (log scale)") +
  theme_classic() +
  ggtitle("") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20))) +
  expand_limits(y = 2)

# Marginal effects plot

variety_instruments_IV_AME_results_plot <- ggplot(variety_instruments_IV_AME_results, aes(Definition, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Average Marginal Effect") +
  theme_classic() +
  ggtitle("") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20))) +
  expand_limits(y = 1.5)

## Without Proportion of Empty Beds (as not a valid instrument)
variety_instruments_IV_AME_results_minus_PropEmpty <- variety_instruments_IV_AME_results %>% 
  filter(!(Definition == "Proportion of CCU beds that are empty"))

variety_instruments_IV_AME_results_minus_PropEmpty_plot <- ggplot(variety_instruments_IV_AME_results_minus_PropEmpty, aes(Definition, AME)) +  
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0, linetype="dashed", 
                color = "red", size=1) +
  coord_flip() + 
  ylab("Average Marginal Effect") +
  theme_classic() +
  ggtitle("") +
  theme(axis.title.y = element_text(margin = margin(r = 20))) +
  theme(axis.title.x = element_text(margin = margin(t = 20))) +
  expand_limits(y = 0.05)

# Combine POMS plots together for publication
combined_variety_instruments_pub_plot <- variety_instruments_IV_results_plot_minus_PropEmpty_plot / variety_instruments_IV_AME_results_minus_PropEmpty_plot 
combined_variety_instruments_pub_plot <- combined_variety_instruments_pub_plot + plot_annotation(tag_levels = 'a')
```


# Calcuate C-stat for models

## Main analyses
Models for investigating variability in probability of postoperative CCU admission between hospital sites
```{r}
## Model A
DescTools::Cstat(x = predict(empty_random_effects_icu_adm, method="response"),                                                                     resp = model.response(model.frame(empty_random_effects_icu_adm))) # 0.75
## Model B
DescTools::Cstat(x = predict(log_ccu_impute_norm_random_effect_critical_adverse_speciality_include, method="response"),                                                                     resp = model.response(model.frame(log_ccu_impute_norm_random_effect_critical_adverse_speciality_include))) #0.93

## Model C 
DescTools::Cstat(x = predict(log_ccu_age_cat_impute_norm_critical_adverse_speciality_totalcap_include, method="response"),                                                                     resp = model.response(model.frame(log_ccu_age_cat_impute_norm_critical_adverse_speciality_totalcap_include))) #0.93

## Model using CCU empty bed categories
DescTools::Cstat(x = predict(log_icu_impute_norm_random_effect_critical_adverse_speciality_include, method="response"),                                                                     resp = model.response(model.frame(log_icu_impute_norm_random_effect_critical_adverse_speciality_include))) #0.93

```

Regression analyses for postoperative CCU admission versus probability of day 7 POMS/30 day mortality/60 day mortality
```{r}
# POMS
## Unadj 
DescTools::Cstat(x = predict(POMS_impute_norm_unadj, method="response"),                                                                     resp = model.response(model.frame(POMS_impute_norm_unadj))) # 0.60

## Random effects
DescTools::Cstat(x = predict(POMS_impute_norm_random_effect, method="response"),                                                                     resp = model.response(model.frame(POMS_impute_norm_random_effect))) # 0.85

# mort 30
## Unadj 
DescTools::Cstat(x = predict(mort30_impute_norm_unadj, method="response"),                                                                     resp = model.response(model.frame(mort30_impute_norm_unadj))) # 0.65

## Random effects
DescTools::Cstat(x = predict(mort30_impute_norm_random_effect, method="response"),                                                                     resp = model.response(model.frame(mort30_impute_norm_random_effect))) # 0.92

# mort 60
## Unadj 
DescTools::Cstat(x = predict(mort60_impute_norm_unadj, method="response"),                                                                     resp = model.response(model.frame(mort60_impute_norm_unadj))) # 0.64
## Random effects
DescTools::Cstat(x = predict(mort60_impute_norm_random_effect, method="response"),                                                                     resp = model.response(model.frame(mort60_impute_norm_random_effect))) # 0.93
```

## Missing 20% occupancy data patients
Regression analyses for postoperative CCU admission versus probability of day 7 POMS/30 day mortality/60 day mortality
```{r}
# POMS
## Unadj 
DescTools::Cstat(x = predict(missing20_log_poms_unadj, method="response"),                                                                     resp = model.response(model.frame(missing20_log_poms_unadj))) # 0.60

## Random effects
DescTools::Cstat(x = predict(missing20_log_poms_random_effect, method="response"),                                                                     resp = model.response(model.frame(missing20_log_poms_random_effect))) # 0.85

# mort 30
## Unadj 
DescTools::Cstat(x = predict(missing20_log_mort30_unadj, method="response"),                                                                     resp = model.response(model.frame(missing20_log_mort30_unadj))) # 0.64

## Random effects
DescTools::Cstat(x = predict(missing20_log_mort30_random_effect, method="response"),                                                                     resp = model.response(model.frame(missing20_log_mort30_random_effect))) # 0.93

# mort 60
## Unadj 
DescTools::Cstat(x = predict(missing20_log_mort60_unadj, method="response"),                                                                     resp = model.response(model.frame(missing20_log_mort60_unadj))) # 0.64

## Random effects
DescTools::Cstat(x = predict(missing20_log_mort60_random_effect, method="response"),                                                                     resp = model.response(model.frame(missing20_log_mort60_random_effect))) # 0.93
```

## Complete Case
Models for investigating variability in probability of postoperative CCU admission between hospital sites
```{r}
## Model A
DescTools::Cstat(x = predict(complete_case_empty_random_effects_icu_adm, method="response"),                                                                     resp = model.response(model.frame(complete_case_empty_random_effects_icu_adm))) # 0.75

## Model B
DescTools::Cstat(x = predict(log_ccu_random_effect_critical_adverse_speciality_include, method="response"),                                                                     resp = model.response(model.frame(log_ccu_random_effect_critical_adverse_speciality_include))) # 0.92

## Model C 
DescTools::Cstat(x = predict(log_ccu_random_effect_critical_adverse_speciality_totalcap_include, method="response"),                                                                     resp = model.response(model.frame(log_ccu_random_effect_critical_adverse_speciality_totalcap_include))) # 0.92

```

Regression analyses for postoperative CCU admission versus probability of day 7 POMS/30 day mortality/60 day mortality
```{r}
# POMS
## Unadj 
DescTools::Cstat(x = predict(POMS_unadj, method="response"),                                                                     resp = model.response(model.frame(POMS_unadj))) # 0.60

## Random effects
DescTools::Cstat(x = predict(log_poms_pars_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_poms_pars_random_effect))) # 0.84

# mort 30
## Unadj 
DescTools::Cstat(x = predict(mort30_unadj, method="response"),                                                                     resp = model.response(model.frame(mort30_unadj))) # 0.64

## Random effects
DescTools::Cstat(x = predict(log_mort30_pars_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_mort30_pars_random_effect))) # 0.92

# mort 60
## Unadj 
DescTools::Cstat(x = predict(mort60_unadj, method="response"),                                                                     resp = model.response(model.frame(mort60_unadj))) # 0.63

## Random effects
DescTools::Cstat(x = predict(log_mort60_pars_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_mort60_pars_random_effect))) # 0.92
```

## Planned CCU only
Models for investigating variability in probability of postoperative CCU admission between hospital sites
```{r}
## Model A
DescTools::Cstat(x = predict(planned_only_empty_random_effects_icu_adm, method="response"),                                                                     resp = model.response(model.frame(planned_only_empty_random_effects_icu_adm))) # 0.76

## Model B
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_include))) # 0.94

## Model C 
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_ccu_pars_random_effect_critical_adverse_speciality_totalcap_include))) # 0.94

```

Regression analyses for postoperative CCU admission versus probability of day 7 POMS/30 day mortality/60 day mortality
```{r}
# POMS
## Unadj 
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_poms, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_poms))) # 0.59

## Random effects
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_poms_pars_random_effect, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_poms_pars_random_effect))) # 0.85

# mort 30
## Unadj 
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_mort30, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_mort30))) # 0.62

## Random effects
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_mort30_pars_random_effect, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_mort30_pars_random_effect))) # 0.92

# mort 60
## Unadj 
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_mort60, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_mort60))) # 0.61

## Random effects
DescTools::Cstat(x = predict(planned_icu_only_imputed_log_mort60_pars_random_effect, method="response"),                                                                     resp = model.response(model.frame(planned_icu_only_imputed_log_mort60_pars_random_effect))) # 0.92
```

## Instruments using different definitions of CCU Bed Availability
Regression analysis for CCU bed availability vs probability of postoperative CCU admission
```{r}
## empty beds
DescTools::Cstat(x = predict(log_icu_continuous_impute_norm_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_icu_continuous_impute_norm_random_effect))) # 0.90

## empty beds (0,1,2+)
DescTools::Cstat(x = predict(log_icu_impute_norm_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_icu_impute_norm_random_effect))) # 0.90

## empty beds (0 vs 2+)
DescTools::Cstat(x = predict(log_empty_0_vs_2_impute_norm_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_empty_0_vs_2_impute_norm_random_effect))) # 0.90

## prop empty beds
DescTools::Cstat(x = predict(log_prop_empty_impute_norm_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_prop_empty_impute_norm_random_effect))) # 0.90

```

## SORT thresholds
Regression analysis for postoperative CCU admission vs incidence of day 7 POMS 
```{r}
## 1+
DescTools::Cstat(x = predict(log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_poms_age_cat_impute_norm_pars_SORT1over_clean_random_effect))) # 0.77

## 2+
DescTools::Cstat(x = predict(log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_poms_age_cat_impute_norm_pars_SORT2over_clean_random_effect))) # 0.75

## 3+
DescTools::Cstat(x = predict(log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_poms_age_cat_impute_norm_pars_sort3over_clean_random_effect))) # 0.72

## 4+
DescTools::Cstat(x = predict(log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_poms_age_cat_impute_norm_pars_sort4over_clean_random_effect))) # 0.69

## 5+
DescTools::Cstat(x = predict(log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect, method="response"),                                                                     resp = model.response(model.frame(log_poms_age_cat_impute_norm_pars_sort5over_clean_random_effect))) # 0.68
```


